---
layout: post
title: "媒体文件格式分析之FLV"
date: 2016-07-24 00:22:21 -0700
comments: true
categories: 总结积累
---

* list element with functor item
{:toc}

[FLV](https://en.wikipedia.org/wiki/Flash_Video) 是 FLASH VIDEO 的简称，FLV 流媒体是随着Flash MX 的推出发展而来的视频格式。FLV 一般由文件头(FLV header) 和文件体(FLV body) 组成。其中文件体(FLV body)由一些列tag组成，tag又可分成三类:audio/video/script，分别代表音频流、视频流、脚本流(关键字或文件信息之类)。
<!--more-->
在 FLV 文件中，每种 tag 类型都由一个单独的流组成，即在 FLV 文件中最多有一个视频流和一个音频流，对同一种类型的流，FLV 中不能够定义多个独立的流。
与 SWF 文件不同,FLV 文件以大字节序存储多字节。比如，0x300(0x12C) 在 SWF 文件中的字节序为 0x2C 0x01,在FLV 文件中则为 0x01 0x2C。

## FLV Header
以 FLV Header `46 4C 56 01 05 00 00 00 09`为例：  

| Field | Type  | Comment |
| :---: | :---: | :---:   |
| Signature | UI8 | Signature byte always 'F'(0x46) |
| Signature | UI8 | Signature byte always 'L'(0x4C) |
| Signature | UI8 | Signature byte always 'V'(0x56) |
| Version   | UI8 | File version(0x01 for FLV version 1) |
| TypeFlagsReserved | UB[5] | Must be 0 |
| TypeFlagsAudio | UB[1] | Audio tags are present |
| TypeFlagsReserved | UB[1] | Must be 0 |
| TypeFlagsVideo | UB[1] | Video tags are present |
| DataOffset | UI32 | Offset in bytes from start of file to start of body(that is size of header) |

`DataOffset`字段在 FLV 1 时，通常是 9。

FLV Header 的前三个字节是固定的`FLV`的 ASCII 码的值`0x46 0x4C 0x56`; 接下来的一个字节表示 FLV 的版本号,例如 0x01 代表 FLV 版本号为 1。第 5 个字节中的第0位和第2位分别表示video和audio的存在情况（1表示存在，0表示不存在）,其余6位必须为0.最后的4字节表示FLV Header的长度，对于version 1，此处为9.  

## FLV File Body
FLV Header 之后，FLV 文件的剩余部分由tag组成，它们交替如下：  

PreviousTagSize0|Tag1|PreviousTagSize1|Tag2|……|PreviousTagSizeN-1|TagN|PreviousTagSizeN

## FLV tags
FLV tags 有以下几个字段构成：8bit的`TagType`、24bit的`DataSize`、24bit的`TimeStamp`、8bit的`TimeStampExtended`、24bit的`StreamID`以及最后的`Data`。

`TagType`指该Tag的类型，8 代表 Audio，9 代表 Video，18 代表 Script Data。

`DataSize`指定后面的`Data`字段的大小。

以 Tag `12 00 12 A9 00 00 00 00 00 00 00 02 00 0A……`为例，`0x12`代表该 tag 为script data，`00 12 A9`代表该 tag 的 DataSize 为 681 byte，`00 00 00`代表该 tag 的 TimeStamp 为 0，`00`代表该 tag 的 TimeStampExtended 为 0，StreamID 总是 0，接下来的 681 byte 为script data 的内容。

播放过程中，FLV tag的时间信息完全依赖于 FLV 时间戳，内置的其他时间信息都被忽略掉。

### Audio tags  

### Video tags  

Video Tag 与 SWF 文件格式中的 VideoFrame Tag 类似，它们的 Payload 数据是同一的。关于 SWF 文件格式的介绍，请看[SWF(File Format Specification)](www.adobe.com/go/swf_file_format)。

以`09 00 00 2D 00 00 00 00 00 00 00 17 00 00 00 00 01 4D 40 1F FF E1 00 19 67 4D 40 ……`为例，`09`表示 Tag Type 为 Video Tag;`00 00 2D`表示 DataSize 为 45；`00 00 00`表示 Timestamp 为 0；`00`表示 TimestampExtended 为 0；`00 00 00`表示 StreamID 为 0；`17`中的 8 bit，其中前 4 bit`1`表示 FrameType 为 keyframe,后 4 bit`7`表示 CodecID 为 AVC；之后的 45 byte 为 VideoData;

### Video Data

| Field | Type  | Comment |
| :---: | :---: | :---:   |
| FrameType | UB[4] | 1.keyframe(for AVC, a seekable frame) 2.inter frame(for AVC, a non-seekable frame) 3.disposable inter frame(H.263 only) 4.generated keyframe(reserved for serve use only) 5.video info/command frame |
| CodeID | UB[4] | 1:JPEG(currently unused) 2:Sorenson H.263 3:Screen video 4:On2 VP6 5:On2 VP6 with alpha channel 6:Screen video version 2 7:AVC |
| VideoData | if CodecID == 7 AVCVIDEOPACKET | Video frame payload or UI8(see note following table) |

如果 FrameType = 5,此时的 VideoData 含义如下：  

* 0 = Start of client-side seeking video frame sequence
* 1 = End of client-side seeking video frame sequence

### AVCVIDEOPACKET

AVCVIDEOPACKET 携带一个AVC video data。

| Field | Type | Comment |
| :---: | :---: | :---:  |
| AVCPacketType | UI8 | 0:AVC sequence header 1:AVC NALU 2:AVC end of sequence |
| CompositionTime | SI24 | if AVCPacketType == 1 CompositionTime offset else 0 |
| Data | UI8[n] | if AVCPacketType == 0 AVCDecoderConfigurationRecord else if AVCPacketType == 1 one or more NALUs |

### onMetaData
* duration : 一个 DOUBLE 指定了整个文件的总时长，单位 seconds
* width : 一个 DOUBLE 指定了视频的宽，单位 pixel
* height : 一个 DOUBLE 指定了视频的高,danwei pixel
* videodatarate : 一个DOUBLE 指定了 video bit rate，单位 kilobits per second
* framerate : 一个DOUBLE 指定了每秒的 frame 数
* videocodeid : 一个DOUBLE 指定了 video codec ID
* audiosamplerate : 一个 DOUBLE 指定了音频采样的分辨率
* stereo : 一个 BOOL 指定了data 是否是stereo
* filesize : 一个 DOUBLE 指定了文件的总大小，单位 byte.

