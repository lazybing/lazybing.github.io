---
layout: post
title: "av1解码详解(一)"
date: 2018-10-15 07:43:02 -0700
comments: true
categories: AV1
---

* list element with functor item
{:toc}

[AV1](https://en.wikipedia.org/wiki/AV1)作为一个开放、免专利的视频编码格式，专为通过网络进行刘传书而设计。学习一个新的视频编解码标准除了看[SPEC](https://aomediacodec.github.io/av1-spec/av1-spec.pdf),最好的方法是看源码`aom`。

<!--more-->

## AV1 前期准备

* 安装`CMake`，版本需求 3.5 以上。
* 安装`Git`。
* 安装`Perl`。
* 对于`x86`,需要安装`yasm`或`nasm`。
* 安装`python`。

## 获取源码

```
$ git clone https://aomedia.googlesource.com/aom
```

## 编译

`AV1`采用的配制方法不再是通常的`config`命令，而是`cmake`.`cmake`会生成配置文件和编译文件，大多数系统中，默认的编译文件是`Makefile`。
执行`cmake`会得到如下提示: 

```
cmake [options] <path-to-source>
...
Options
    -G <generator-name> = Specify a build system generator.
```

某些参数可以直接通过 cmake传递进去，如是否编译`encoder`。

> 其实不止 AV1 的官方代码，`DAV1D`工程，同样有类似的配置过程，只不过它使用的是`meson`而不是`cmake`，但效果是一样的。

### Linux 下编译方法

Linux 下的编译最简单了，只需要用`cmake`配置，然后`make`编译即可。

```
$ cmake path/to/aom
$ make
```
上面的方法就可以用到`Linux`平台下，生成`aomdec`可执行文件，进行解码。

### Windows 下编译方法

`Windows`下使用`Visual Studio`同样可以编译运行`av1`的代码。只需要在`cmake`时指定 VS 版本号即可,支持的工具可以通过`cmake --help`来查看。

```
$ make aom_vs
$ cd aom_vs
$ cmake /path/to/aom -G "Visual Studio 12 2013 Win64" -DCONFIG_AV1_ENCODER=0 -DCONFIG_LOWBITDEPTH=0 -DAOM_TARGET_CPU=generic
```
此时在`aom_vs`路径下，会生成一个`AOM.sln`,用`VisualStudio 2013`打开该文件后，编译运行即可使用`VisualStudio`调试学习了。

### 交叉编译

```
$ mkdir aom_armv7
$ cd aom_armv7
$ CFLAGS="-pie -fPIE" LDFLAGS="-pie -fpIE" cmake /path/to/aom -DCROSS=/path/to/cross_build_tool_bin/ -DCMAKE_TOOLCHAIN_FILE=/path/to/tools -DCONFIG_AV1_ENCODER=0 -DCONFIG_LOWBITDEPTH=0
$ make
```

## 配置选项

上面再编译的过程中，已经提到了很多配置选项，在此举几个例子：

* `-DCONFIG_AV1_ENCODER=0`表示不编译`av1 encoder`。
* `-DAOM_TARGET_CPU=generic`表示不编译汇编。
* `-G "Visual Studio 12 2013 Win64"`表示生成的配置文件，可以通过`VS2013`来打开编译运行。
* `-DCMAKE_CONFIGURATION_TYPES=Debg`表示生成Debug 类型的可执行文件。

## 参考文档

[AV1 Codec Library](https://aomedia.googlesource.com/aom/+/master/README.md)

