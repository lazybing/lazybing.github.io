---
layout: post
title: "av1解码详解(一)"
date: 2018-10-15 07:43:02 -0700
comments: true
categories: AV1
---

* list element with functor item
{:toc}

[AV1](https://en.wikipedia.org/wiki/AV1)作为一个开放、免专利的视频编码格式，专为通过网络进行刘传书而设计。学习一个新的视频编解码标准除了看[SPEC](https://aomediacodec.github.io/av1-spec/av1-spec.pdf),最好的方法是看源码`aom`。本文主要记录官方工程 AOM 和 DAV1D 两个工程的建立。

<!--more-->

## AOM 工程 

### AV1 前期准备

* 安装`CMake`，版本需求 3.5 以上。
* 安装`Git`。
* 安装`Perl`。
* 对于`x86`,需要安装`yasm`或`nasm`。
* 安装`python`。

### 获取源码

```
$ git clone https://aomedia.googlesource.com/aom
```

### 编译

`AV1`采用的配制方法不再是通常的`config`命令，而是`cmake`.`cmake`会生成配置文件和编译文件，大多数系统中，默认的编译文件是`Makefile`。
执行`cmake`会得到如下提示: 

```
cmake [options] <path-to-source>
...
Options
    -G <generator-name> = Specify a build system generator.
```

某些参数可以直接通过 cmake传递进去，如是否编译`encoder`。

> 其实不止 AV1 的官方代码，`DAV1D`工程，同样有类似的配置过程，只不过它使用的是`meson`而不是`cmake`，但效果是一样的。

#### Linux 下编译方法

Linux 下的编译最简单了，只需要用`cmake`配置，然后`make`编译即可。

```
$ cmake path/to/aom
$ make
```
上面的方法就可以用到`Linux`平台下，生成`aomdec`可执行文件，进行解码。

#### Windows 下编译方法

`Windows`下使用`Visual Studio`同样可以编译运行`av1`的代码。只需要在`cmake`时指定 VS 版本号即可,支持的工具可以通过`cmake --help`来查看。

```
$ make aom_vs
$ cd aom_vs
$ cmake /path/to/aom -G "Visual Studio 12 2013 Win64" -DCONFIG_AV1_ENCODER=0 -DCONFIG_LOWBITDEPTH=0 -DAOM_TARGET_CPU=generic
```
此时在`aom_vs`路径下，会生成一个`AOM.sln`,用`VisualStudio 2013`打开该文件后，编译运行即可使用`VisualStudio`调试学习了。

#### 交叉编译

```
$ mkdir aom_armv7
$ cd aom_armv7
$ CFLAGS="-pie -fPIE" LDFLAGS="-pie -fpIE" cmake /path/to/aom -DCROSS=/path/to/cross_build_tool_bin/ -DCMAKE_TOOLCHAIN_FILE=/path/to/tools -DCONFIG_AV1_ENCODER=0 -DCONFIG_LOWBITDEPTH=0
$ make
```

### 配置选项

上面再编译的过程中，已经提到了很多配置选项，在此举几个例子：

* `-DCONFIG_AV1_ENCODER=0`表示不编译`av1 encoder`。
* `-DAOM_TARGET_CPU=generic`表示不编译汇编。
* `-G "Visual Studio 12 2013 Win64"`表示生成的配置文件，可以通过`VS2013`来打开编译运行。
* `-DCMAKE_CONFIGURATION_TYPES=Debg`表示生成Debug 类型的可执行文件。

### AOM VS 工程

{% img /images/av1_startup/aom_vs.png %}

## DAV1D 工程

DAV1D 工程是一个跨平台的 AV1 解码器，该开源项目的目标是加速解码进度，解决目前还没有硬件支持 AV1 解码的问题。它包括了大多数 AOM 工程的特性。浏览该工程源码，该源码代码比较紧凑、很多函数甚至是宏定义完成的，调试非常困难……

### DAV1D 下载

```
$git clone git@code.videolan.org:videolan/dav1d.git
$git clont https://code.videolan.org/videolan/dav1d.git
```

### DAV1D 工程编译

1. 安装`Meson(0.47或更高版本)和 Ninja`，如果是 x86 平台，需要安装`nasm(2.13.02或更高版本)`
2. cd dav1d
3. `meson --buildtype debug --backend vs2017 ./ vs2017`，其中各个参数的含义，可以通过`meson --help`命令查看，注意，该命令的执行要在 Visual Studio 工程的 Native Tool Command 下执行。有时可能是安装时的配置的问题，即使在 Native Tool Command 下执行，仍然有问题，我是在`Developer Command Prompt for VS 2017`下执行成功的。
4. 安装完成后，就可以使用 Visual Studio 2017 打开 dav1d.sln 了。

### DAV1D VS 工程

{% img /images/av1_startup/dav1d_vs.png %}

### 参考文档

[AV1 Codec Library](https://aomedia.googlesource.com/aom/+/master/README.md)

***欢迎添加微信交流***

