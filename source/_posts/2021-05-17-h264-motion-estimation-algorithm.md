---
layout: post
title: "H264 Motion Estimation Algorithm"
date: 2021-05-17 07:54:51 -0700
comments: true
categories: x264
---

* list element with functor item
{:toc}

运动估计是寻找运动矢量的过程。在整个编码过程中，运动估计耗时占了整个编码过程的60%-80%不等，因此，对运动估计的优化是实现视频实时应用的关键。

H264 中运动估计的过程分为两步：1. 整数像素精度的估计。2. 分数像素级精度的估计。其中整数像素级的运动估计包括两类算法：全搜索算法、快速搜索算法(DIA/HEX/UMH)。

<!--more-->

## 钻石搜索算法

钻石搜索算法有两种搜索模式：

* 大钻石搜索算法(LDSP)
* 小钻石搜索算法(SDSP)
    
大钻石搜索算法有 9 个搜索点，小钻石搜索算法有 5 个搜索点。

{% img /images/h264_me/diamond_search.png %}

从上图可以看出，钻石搜索的步骤是：

* LDSP:

1. 从中心搜索位置开始，设置步长 S = 2
2. 使用钻石搜索点图案搜索 8 个位置像素(X, Y), 以使(|x| + |Y| = S) 围绕位置 (0, 0)
3. 从搜索到的 9 个地点中选择，其中一个地点的费用最低
4. 如果在搜索窗口的中心找到了最小重量，请转到 SDSP 步骤
5. 如果在除中心以为的 8 个位置之一中找到最小重量，则将新的原点设置为此位置
6. 重复 LDSP

* SDSP：

1. 设置新的搜索原点
2. 将新步长设置为 S = S / 2
3. 重复搜索过程以找到重量最轻的位置
4. 选择权重最小的位置作为运动矢量权重最小的运动矢量位置。

x264 中只采用了钻石搜索里的小钻石搜索算法。 具体代码实现如下:

{% codeblock lang:c %}
bcost <<= 4
int i = i_me_range;

do
{
    COST_MV_X4_DIR(0, -1, 0, 1, -1, 0, 1, 0, costs);
    COPY1_IF_LT(bcost, (costs[0] << 4) + 1);
    COPY1_IF_LT(bcost, (costs[1] << 4) + 1);
    COPY1_IF_LT(bcost, (costs[2] << 4) + 1);
    COPY1_IF_LT(bcost, (costs[3] << 4) + 1);
    if (!(bcost&15))
        break;
    bmx -= (bcost << 28) >> 30;
    bmy -= (bcost << 30) >> 30;
    bcost &= ~15;
}while(--i &&CHECK_MVRANGE(bmx, bmy));
bcost >> 4;
{% endcodeblock %}

## 六边形搜索算法

## 非对称交叉多层次六边形网格搜索算法

UMH 算法是基于 MV 具有时空相关性，因此可以结合上一帧和上一步中 MV 的方向和角度，来修改多层六边形的形状。

UMH 算法包含四中搜索模式:不均匀交叉搜索、多六边形网格搜索、迭代六边形搜索、菱形搜索。主要流程步骤如下:

1. 初始化搜索点。

2. 小菱形搜索和中菱形搜索。

3. 对称交叉搜索和六边形搜索。

4. 非对称交叉搜索。

5. 5x5搜索和多六边形网格搜索。

6. 迭代六边形搜索。


