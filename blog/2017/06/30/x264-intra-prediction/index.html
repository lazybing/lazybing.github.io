
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>X264 源码解析之帧内预测 - 懒人李冰</title>
  <meta name="author" content="李冰">

  
  <meta name="description" content="Intra_4x4 预测模式 Intra_4x4_Vertical 预测模式 Intra_4x4_Horizontal 预测模式 Intra_4x4_DC 预测模式 Intra_4x4_Diagonal_Down_Left 预测模式 Intra_4x4_Diagonal_Down_Right &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://lazybing.github.io/blog/2017/06/30/x264-intra-prediction/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="懒人李冰" type="application/atom+xml">
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-77812244-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">懒人李冰</a></h1>
  
    <h2>记录我的生活、学习</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="订阅RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="lazybing.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="搜索"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">首页</a></li>
  <li><a href="/blog/archives">文章列表</a></li>
  <li><a href="/photography/">摄影作品</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">X264 源码解析之帧内预测</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-06-30T08:12:22-07:00'><span class='date'>2017 年 06 月 30 日</span> <span class='time'>8:12 am</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><ul id="markdown-toc">
  <li><a href="#intra4x4-" id="markdown-toc-intra4x4-">Intra_4x4 预测模式</a>    <ul>
      <li><a href="#intra4x4vertical-" id="markdown-toc-intra4x4vertical-">Intra_4x4_Vertical 预测模式</a></li>
      <li><a href="#intra4x4horizontal-" id="markdown-toc-intra4x4horizontal-">Intra_4x4_Horizontal 预测模式</a></li>
      <li><a href="#intra4x4dc-" id="markdown-toc-intra4x4dc-">Intra_4x4_DC 预测模式</a></li>
      <li><a href="#intra4x4diagonaldownleft-" id="markdown-toc-intra4x4diagonaldownleft-">Intra_4x4_Diagonal_Down_Left 预测模式</a></li>
      <li><a href="#intra4x4diagonaldownright-" id="markdown-toc-intra4x4diagonaldownright-">Intra_4x4_Diagonal_Down_Right 预测模式</a></li>
      <li><a href="#intra4x4verticalright-" id="markdown-toc-intra4x4verticalright-">Intra_4x4_Vertical_Right 预测模式</a></li>
      <li><a href="#intra4x4horizontaldown-" id="markdown-toc-intra4x4horizontaldown-">Intra_4x4_Horizontal_Down 预测模式</a></li>
      <li><a href="#intra4x4verticalleft-" id="markdown-toc-intra4x4verticalleft-">Intra_4x4_Vertical_Left 预测模式</a></li>
      <li><a href="#intra4x4horizontalup-" id="markdown-toc-intra4x4horizontalup-">Intra_4x4_Horizontal_Up 预测模式</a></li>
    </ul>
  </li>
  <li><a href="#intra8x8-" id="markdown-toc-intra8x8-">Intra_8x8 预测模式</a>    <ul>
      <li><a href="#intra8x8vertical-" id="markdown-toc-intra8x8vertical-">Intra_8x8_Vertical 预测模式</a></li>
      <li><a href="#intra8x8horizontal-" id="markdown-toc-intra8x8horizontal-">Intra_8x8_Horizontal 预测模式</a></li>
      <li><a href="#intra8x8dc-" id="markdown-toc-intra8x8dc-">Intra_8x8_DC 预测模式</a></li>
      <li><a href="#intra8x8diagonaldownleft-" id="markdown-toc-intra8x8diagonaldownleft-">Intra_8x8_Diagonal_Down_Left 预测模式</a></li>
      <li><a href="#intra8x8diagonaldownright-" id="markdown-toc-intra8x8diagonaldownright-">Intra_8x8_Diagonal_Down_Right 预测模式</a></li>
      <li><a href="#intra8x8verticalright-" id="markdown-toc-intra8x8verticalright-">Intra_8x8_Vertical_Right 预测模式</a></li>
      <li><a href="#intra8x8horizontaldown-" id="markdown-toc-intra8x8horizontaldown-">Intra_8x8_Horizontal_Down 预测模式</a></li>
      <li><a href="#intra8x8verticalleft-" id="markdown-toc-intra8x8verticalleft-">Intra_8x8_Vertical_Left 预测模式</a></li>
      <li><a href="#intra8x8horizontalup-" id="markdown-toc-intra8x8horizontalup-">Intra_8x8_Horizontal_Up 预测模式</a></li>
    </ul>
  </li>
  <li><a href="#intra16x16-" id="markdown-toc-intra16x16-">Intra_16x16 预测模式</a>    <ul>
      <li><a href="#intra16x16vertical-" id="markdown-toc-intra16x16vertical-">Intra_16x16_Vertical 预测模式</a></li>
      <li><a href="#intra16x16horizontal-" id="markdown-toc-intra16x16horizontal-">Intra_16x16_Horizontal 预测模式</a></li>
      <li><a href="#intra16x16dc-" id="markdown-toc-intra16x16dc-">Intra_16x16_DC 预测模式</a></li>
      <li><a href="#intra16x16plane-" id="markdown-toc-intra16x16plane-">Intra_16x16_Plane 预测模式</a></li>
    </ul>
  </li>
</ul>

<p>本文主要记录 x264 中使用到的帧内预测技术。</p>

<!--more-->

<h2 id="intra4x4-">Intra_4x4 预测模式</h2>

<p>x264 中对 4x4 的预测模式如下：</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Intra4x4PredMode[luma4x4BlkIdx]</th>
      <th style="text-align: center">Name of Intra4x4PredMode[luma4x4BlkIdx]</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">0</td>
      <td style="text-align: center">Intra_4x4_Vertical(prediction mode)</td>
    </tr>
    <tr>
      <td style="text-align: center">1</td>
      <td style="text-align: center">Intra_4x4_Horizontal(prediction mode)</td>
    </tr>
    <tr>
      <td style="text-align: center">2</td>
      <td style="text-align: center">Intra_4x4_DC(prediction mode)</td>
    </tr>
    <tr>
      <td style="text-align: center">3</td>
      <td style="text-align: center">Intra_4x4_Diagonal_Down_Left(prediction mode)</td>
    </tr>
    <tr>
      <td style="text-align: center">4</td>
      <td style="text-align: center">Intra_4x4_Diagonal_Down_Right(prediction mode)</td>
    </tr>
    <tr>
      <td style="text-align: center">5</td>
      <td style="text-align: center">Intra_4x4_Vertical_Right(prediction mode)</td>
    </tr>
    <tr>
      <td style="text-align: center">6</td>
      <td style="text-align: center">Intra_4x4_Horizontal_Down(prediction mode)</td>
    </tr>
    <tr>
      <td style="text-align: center">7</td>
      <td style="text-align: center">Intra_4x4_Vertical_Left(prediction mode)</td>
    </tr>
    <tr>
      <td style="text-align: center">8</td>
      <td style="text-align: center">Intra_4x4_Horizontal_Up(prediction mode)</td>
    </tr>
  </tbody>
</table>

<p>下面依次分析这几种预测模式：</p>

<h3 id="intra4x4vertical-">Intra_4x4_Vertical 预测模式</h3>

<p>在 SPEC 中，关于该预测模式的定义如下：</p>

<blockquote><p>This Intra_4x4 prediction mode is invoked when Intra4x4PredMode[ luma4x4BlkIdx ] is equal to 0.<br />This mode shall be used only when the samples p[ x, -1 ] with x = 0..3 are marked as "available for Intra_4x4 prediction".<br />The values of the prediction samples pred4x4L[ x, y ], with x, y = 0..3, are derived by  <br />$pred4x4_L[x,y]=p[x,-1], with x,y=0..3$</p></blockquote>

<p>x264 中关于模式 Intra_4x4_Vertical 的代码如下：</p>

<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="c"><span class="line"><span class="kt">void</span> <span class="nf">x264_predict_4x4_v_c</span><span class="p">(</span> <span class="n">pixel</span> <span class="o">*</span><span class="n">src</span> <span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">PREDICT_4x4_DC</span><span class="p">(</span><span class="n">SRC_X4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line"><span class="cp">#define SRC(x,y) src[(x)+(y)*FDEC_STRIDE]</span>
</span><span class="line"><span class="cp">#define SRC_X4(x,y) MPIXEL_X4( &amp;SRC(x,y) )</span>
</span><span class="line">
</span><span class="line"><span class="cp">#define PREDICT_4x4_DC(v)\</span>
</span><span class="line"><span class="cp">    SRC_X4(0,0) = SRC_X4(0,1) = SRC_X4(0,2) = SRC_X4(0,3) = v;</span>
</span></code></pre></td></tr></table></div></figure>

<h3 id="intra4x4horizontal-">Intra_4x4_Horizontal 预测模式</h3>

<p>在 SPEC 中，关于该预测模式的定义如下：</p>

<blockquote><p>This Intra_4x4 prediction mode is invoked when Intra4x4PredMode[ luma4x4BlkIdx ] is equal to 1.  <br />This mode shall be used only when the samples p[ −1, y ], with y = 0..3, are marked as "available for Intra_4x4 prediction".<br />The values of the prediction samples pred4x4L[ x, y ], with x, y = 0..3, are derived by  <br />$pred4x4_L[x,y]=p[-1, y], with x,y=0..3$</p></blockquote>

<p>x264 中关于模式 Intra_4x4_Vertical 的代码如下：</p>

<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="c"><span class="line"><span class="kt">void</span> <span class="nf">x264_predict_4x4_h_c</span><span class="p">(</span> <span class="n">pixel</span> <span class="o">*</span><span class="n">src</span> <span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">SRC_X4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">PIXEL_SPLAT_X4</span><span class="p">(</span> <span class="n">SRC</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">);</span>
</span><span class="line">    <span class="n">SRC_X4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">PIXEL_SPLAT_X4</span><span class="p">(</span> <span class="n">SRC</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="p">);</span>
</span><span class="line">    <span class="n">SRC_X4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">PIXEL_SPLAT_X4</span><span class="p">(</span> <span class="n">SRC</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="p">);</span>
</span><span class="line">    <span class="n">SRC_X4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">PIXEL_SPLAT_X4</span><span class="p">(</span> <span class="n">SRC</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h3 id="intra4x4dc-">Intra_4x4_DC 预测模式</h3>

<p>在 SPEC 中，关于该预测模式的定义如下：</p>

<blockquote><p>This Intra_4x4 prediction mode is invoked when Intra4x4PredMode[ luma4x4BlkIdx ] is equal to 2.<br />The values of the prediction samples $pred4x4_L[ x, y ]$, with x, y = 0..3, are derived as follows:  </p><p>If all samples p[ x, −1 ], with x = 0..3, and p[ −1, y ], with y = 0..3, are marked as "available for Intra_4x4 prediction", the values of the prediction samples $pred4x4_L$[ x, y ], with x, y = 0..3, are derived by  <br />$pred4x4_L[x,y]$ = (p[0,-1]+p[1,-1]+p[2,-1]+p[3,-1]+p[-1,0]+p[-1,1]+p[-1,2]+p[-1,3]+4)&gt;&gt;3  </p><p>Otherwise, if any samples p[ x, .1 ], with x = 0..3, are marked as "not available for Intra_4x4 prediction" and all samples p[ .1, y ], with y = 0..3, are marked as "available for Intra_4x4 prediction", the values of the prediction samples $pred4x4_L$[ x, y ], with x, y = 0..3, are derived by  <br />$pred4x4_L[x,y] = (p[-1,0]+p[-1,1]+p[-1,2]+p[-1,3]+2)&gt;&gt;2$  </p><p>Otherwise, if any samples p[ .1, y ], with y = 0..3, are marked as "not available for Intra_4x4 prediction" and all samples p[ x, .1 ], with x = 0 .. 3, are marked as "available for Intra_4x4 prediction", the values of the prediction samples $pred4x4_L$[ x, y ], with x, y = 0 .. 3, are derived by    <br />$pred4x4_L[x,y] = (p[0,-1]+p[1,-1]+p[2,-1]+p[3,-1]+2)&gt;&gt;2$    </p><p>Otherwise (some samples p[ x, .1 ], with x = 0..3, and some samples p[ .1, y ], with y = 0..3, are marked as "not available for Intra_4x4 prediction"), the values of the prediction samples $pred4x4_L$[ x, y ], with x, y = 0..3, are derived by  <br />$pred4x4_L[x,y]=(1&lt;&lt;(BitDepth_Y-1))$</p></blockquote>

<p>x264 中关于模式 Intra_4x4_DC 的代码如下：</p>

<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="c"><span class="line"><span class="k">static</span> <span class="kt">void</span> <span class="nf">x264_predict_4x4_dc_128_c</span><span class="p">(</span> <span class="n">pixel</span> <span class="o">*</span><span class="n">src</span> <span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">PREDICT_4x4_DC</span><span class="p">(</span> <span class="n">PIXEL_SPLAT_X4</span><span class="p">(</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">BIT_DEPTH</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line"><span class="k">static</span> <span class="kt">void</span> <span class="nf">x264_predict_4x4_dc_left_c</span><span class="p">(</span> <span class="n">pixel</span> <span class="o">*</span><span class="n">src</span> <span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">pixel4</span> <span class="n">dc</span> <span class="o">=</span> <span class="n">PIXEL_SPLAT_X4</span><span class="p">(</span> <span class="p">(</span><span class="n">SRC</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">SRC</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">SRC</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">SRC</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span> <span class="p">);</span>
</span><span class="line">    <span class="n">PREDICT_4x4_DC</span><span class="p">(</span> <span class="n">dc</span> <span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line"><span class="k">static</span> <span class="kt">void</span> <span class="nf">x264_predict_4x4_dc_top_c</span><span class="p">(</span> <span class="n">pixel</span> <span class="o">*</span><span class="n">src</span> <span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">pixel4</span> <span class="n">dc</span> <span class="o">=</span> <span class="n">PIXEL_SPLAT_X4</span><span class="p">(</span> <span class="p">(</span><span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span> <span class="p">);</span>
</span><span class="line">    <span class="n">PREDICT_4x4_DC</span><span class="p">(</span> <span class="n">dc</span> <span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line"><span class="kt">void</span> <span class="nf">x264_predict_4x4_dc_c</span><span class="p">(</span> <span class="n">pixel</span> <span class="o">*</span><span class="n">src</span> <span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">pixel4</span> <span class="n">dc</span> <span class="o">=</span> <span class="n">PIXEL_SPLAT_X4</span><span class="p">(</span> <span class="p">(</span><span class="n">SRC</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">SRC</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">SRC</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">SRC</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span>
</span><span class="line">                                 <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span> <span class="p">);</span>
</span><span class="line">    <span class="n">PREDICT_4x4_DC</span><span class="p">(</span> <span class="n">dc</span> <span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h3 id="intra4x4diagonaldownleft-">Intra_4x4_Diagonal_Down_Left 预测模式</h3>

<p>在 SPEC 中，关于该预测模式的定义如下：</p>

<blockquote><p>This Intra_4x4 prediction mode is invoked when Intra4x4PredMode[ luma4x4BlkIdx ] is equal to 3.<br />This mode shall be used only when the samples p[ x, −1 ] with x = 0..7 are marked as "available for Intra_4x4 prediction".<br />The values of the prediction samples $pred4x4_L[ x, y ]$, with x, y = 0..3, are derived as follows:  </p><p>If x is equal to 3 and y is equal to 3,<br />$pred4x4_L[ x, y ] = ( p[ 6, .1 ] + 3 * p[ 7, .1 ] + 2 ) &gt;&gt; 2$</p><p>Otherwise (x is not equal to 3 or y is not equal to 3),<br />$pred4x4_L[ x, y ] = ( p[ x + y, −1 ] + 2 * p[ x + y + 1, −1 ] + p[ x + y + 2, −1 ] + 2 ) &gt;&gt; 2$</p></blockquote>

<p>x264 中关于模式 Intra_4x4_DC 的代码如下：</p>

<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
</pre></td><td class="code"><pre><code class="c"><span class="line"><span class="cp">#define PREDICT_4x4_LOAD_LEFT\</span>
</span><span class="line"><span class="cp">    int l0 = SRC(-1,0);\</span>
</span><span class="line"><span class="cp">    int l1 = SRC(-1,1);\</span>
</span><span class="line"><span class="cp">    int l2 = SRC(-1,2);\</span>
</span><span class="line"><span class="cp">    UNUSED int l3 = SRC(-1,3);</span>
</span><span class="line">
</span><span class="line"><span class="cp">#define PREDICT_4x4_LOAD_TOP\</span>
</span><span class="line"><span class="cp">    int t0 = SRC(0,-1);\</span>
</span><span class="line"><span class="cp">    int t1 = SRC(1,-1);\</span>
</span><span class="line"><span class="cp">    int t2 = SRC(2,-1);\</span>
</span><span class="line"><span class="cp">    UNUSED int t3 = SRC(3,-1);</span>
</span><span class="line">
</span><span class="line"><span class="cp">#define PREDICT_4x4_LOAD_TOP_RIGHT\</span>
</span><span class="line"><span class="cp">    int t4 = SRC(4,-1);\</span>
</span><span class="line"><span class="cp">    int t5 = SRC(5,-1);\</span>
</span><span class="line"><span class="cp">    int t6 = SRC(6,-1);\</span>
</span><span class="line"><span class="cp">    UNUSED int t7 = SRC(7,-1);</span>
</span><span class="line">
</span><span class="line"><span class="cp">#define F1(a,b)   (((a)+(b)+1)&gt;&gt;1)</span>
</span><span class="line"><span class="cp">#define F2(a,b,c) (((a)+2*(b)+(c)+2)&gt;&gt;2)</span>
</span><span class="line">
</span><span class="line"><span class="k">static</span> <span class="kt">void</span> <span class="nf">x264_predict_4x4_ddl_c</span><span class="p">(</span> <span class="n">pixel</span> <span class="o">*</span><span class="n">src</span> <span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">PREDICT_4x4_LOAD_TOP</span>
</span><span class="line">    <span class="n">PREDICT_4x4_LOAD_TOP_RIGHT</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">t3</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span><span class="n">t3</span><span class="p">,</span><span class="n">t4</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t3</span><span class="p">,</span><span class="n">t4</span><span class="p">,</span><span class="n">t5</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t4</span><span class="p">,</span><span class="n">t5</span><span class="p">,</span><span class="n">t6</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t5</span><span class="p">,</span><span class="n">t6</span><span class="p">,</span><span class="n">t7</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t6</span><span class="p">,</span><span class="n">t7</span><span class="p">,</span><span class="n">t7</span><span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h3 id="intra4x4diagonaldownright-">Intra_4x4_Diagonal_Down_Right 预测模式</h3>

<p>在 SPEC 中，关于该预测模式的定义如下：</p>

<blockquote><p>This Intra_4x4 prediction mode is invoked when Intra4x4PredMode[ luma4x4BlkIdx ] is equal to 4.<br />This mode shall be used only when the samples p[ x, .1 ] with x = 0..3 and p[ .1, y ] with y = .1..3 are marked as "available for Intra_4x4 prediction".<br />The values of the prediction samples $pred4x4_L[ x, y ]$, with x, y = 0..3, are derived as follows:  <br />If x is greater than y,  <br />$pred4x4_L[ x, y ] = ( p[ x − y − 2, −1] + 2 * p[ x − y − 1, −1 ] + p[ x − y, −1 ] + 2 ) &gt;&gt; 2$<br />Otherwise if x is less than y,  <br />$pred4x4_L[ x, y ] = ( p[ −1, y − x − 2 ] + 2 * p[ −1, y − x − 1 ] + p[ −1, y − x ] + 2 ) &gt;&gt; 2$<br />Otherwise (x is equal to y),  <br />$pred4x4_L[ x, y ] = ( p[ 0, .1 ] + 2 * p[ .1, .1 ] + p[ .1, 0 ] + 2 ) &gt;&gt; 2$</p></blockquote>

<p>x264 中关于模式 Intra_4x4_Diagonal_Down_Right 的代码如下：</p>

<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="c"><span class="line"><span class="k">static</span> <span class="kt">void</span> <span class="nf">x264_predict_4x4_ddr_c</span><span class="p">(</span> <span class="n">pixel</span> <span class="o">*</span><span class="n">src</span> <span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">lt</span> <span class="o">=</span> <span class="n">SRC</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span><span class="line">    <span class="n">PREDICT_4x4_LOAD_LEFT</span>
</span><span class="line">    <span class="n">PREDICT_4x4_LOAD_TOP</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t3</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">t1</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t0</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">t0</span><span class="p">,</span><span class="n">lt</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span><span class="n">lt</span><span class="p">,</span><span class="n">l0</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">lt</span><span class="p">,</span><span class="n">l0</span><span class="p">,</span><span class="n">l1</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">l0</span><span class="p">,</span><span class="n">l1</span><span class="p">,</span><span class="n">l2</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">l1</span><span class="p">,</span><span class="n">l2</span><span class="p">,</span><span class="n">l3</span><span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h3 id="intra4x4verticalright-">Intra_4x4_Vertical_Right 预测模式</h3>

<p>在 SPEC 中，关于该预测模式的定义如下：</p>

<blockquote><p>This Intra_4x4 prediction mode is invoked when Intra4x4PredMode[ luma4x4BlkIdx ] is equal to 5.<br />This mode shall be used only when the samples p[ x, −1 ] with x = 0..3 and p[ −1, y ] with y = −1..3 are marked as "available for Intra_4x4 prediction".<br />Let the variable zVR be set equal to 2 * x − y.<br />The values of the prediction samples $pred4x4_L[ x, y ]$, with x, y = 0..3, are derived as follows:  </p><p>If zVR is equal to 0,2,4 or 6,  <br />$pred_L[x,y]=(p[x-(y&gt;&gt;1)-1,-1]+p[x-(y&gt;&gt;1),-1]+1)&gt;&gt;1$  <br />Otherwise, if zVR is equal to 1, 3, or 5,  <br />$pred4x4_L[x,y]=(p[x-(y&gt;&gt;1)-2,-1]+2*p[x-(y&gt;&gt;1)-1,-1]+p[x-(y&gt;&gt;1),-1]+2)&gt;&gt;2$<br />Otherwise, if zVR is equal to −1,  <br />$pred4x4_L[ x, y ] = (p[-1, 0 ] + 2 * p[ -1, -1 ] + p[ 0, -1 ] + 2 ) &gt;&gt; 2$<br />Otherwise (zVR is equal to -2 or -3),<br />$pred4x4_L[ x, y ] = ( p[ −1, y − 1 ] + 2 * p[ −1, y − 2 ] + p[ −1, y − 3 ] + 2 ) &gt;&gt; 2$</p></blockquote>

<p>x264 中关于模式 Intra_4x4_Vertical_Right 的代码如下：</p>

<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="c"><span class="line"><span class="k">static</span> <span class="kt">void</span> <span class="nf">x264_predict_4x4_vr_c</span><span class="p">(</span> <span class="n">pixel</span> <span class="o">*</span><span class="n">src</span> <span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">lt</span> <span class="o">=</span> <span class="n">SRC</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span><span class="line">    <span class="n">PREDICT_4x4_LOAD_LEFT</span>
</span><span class="line">    <span class="n">PREDICT_4x4_LOAD_TOP</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">l2</span><span class="p">,</span><span class="n">l1</span><span class="p">,</span><span class="n">l0</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">l1</span><span class="p">,</span><span class="n">l0</span><span class="p">,</span><span class="n">lt</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">l0</span><span class="p">,</span><span class="n">lt</span><span class="p">,</span><span class="n">t0</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span> <span class="n">F1</span><span class="p">(</span><span class="n">lt</span><span class="p">,</span><span class="n">t0</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">lt</span><span class="p">,</span><span class="n">t0</span><span class="p">,</span><span class="n">t1</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span> <span class="n">F1</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span><span class="n">t1</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span> <span class="n">F1</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">t3</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span> <span class="n">F1</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span><span class="n">t3</span><span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h3 id="intra4x4horizontaldown-">Intra_4x4_Horizontal_Down 预测模式</h3>

<p>在 SPEC 中，关于该预测模式的定义如下：</p>

<blockquote><p>This Intra_4x4 prediction mode is invoked when Intra4x4PredMode[ luma4x4BlkIdx ] is equal to 6.<br />This mode shall be used only when the samples p[ x, -1 ] with x = 0..3 and p[ -1, y ] with y = .1..3 are marked as "available for Intra_4x4 prediction".<br />Let the variable zHD be set equal to 2 * y - x.<br />The values of the prediction samples $pred4x4_L[ x, y ]$, with x, y = 0..3, are derived as follows:</p></blockquote>

<p>x264 中关于模式 Intra_4x4_Horizontal_Down 的代码如下：</p>

<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="c"><span class="line"><span class="k">static</span> <span class="kt">void</span> <span class="nf">x264_predict_4x4_hd_c</span><span class="p">(</span> <span class="n">pixel</span> <span class="o">*</span><span class="n">src</span> <span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">lt</span><span class="o">=</span> <span class="n">SRC</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span><span class="line">    <span class="n">PREDICT_4x4_LOAD_LEFT</span>
</span><span class="line">    <span class="n">PREDICT_4x4_LOAD_TOP</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span> <span class="n">F1</span><span class="p">(</span><span class="n">l2</span><span class="p">,</span><span class="n">l3</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">l1</span><span class="p">,</span><span class="n">l2</span><span class="p">,</span><span class="n">l3</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span> <span class="n">F1</span><span class="p">(</span><span class="n">l1</span><span class="p">,</span><span class="n">l2</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">l0</span><span class="p">,</span><span class="n">l1</span><span class="p">,</span><span class="n">l2</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span> <span class="n">F1</span><span class="p">(</span><span class="n">l0</span><span class="p">,</span><span class="n">l1</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">lt</span><span class="p">,</span><span class="n">l0</span><span class="p">,</span><span class="n">l1</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span> <span class="n">F1</span><span class="p">(</span><span class="n">lt</span><span class="p">,</span><span class="n">l0</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span><span class="n">lt</span><span class="p">,</span><span class="n">l0</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">t0</span><span class="p">,</span><span class="n">lt</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t0</span><span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h3 id="intra4x4verticalleft-">Intra_4x4_Vertical_Left 预测模式</h3>

<p>在 SPEC 中，关于该预测模式的定义如下：</p>

<blockquote><p>This Intra_4x4 prediction mode is invoked when Intra4x4PredMode[ luma4x4BlkIdx ] is equal to 7.<br />This mode shall be used only when the samples p[ x, −1 ] with x = 0..7 are marked as "available for Intra_4x4 prediction".<br />The values of the prediction samples $pred4x4_L[ x, y ]$, with x, y = 0..3, are derived as follows:</p></blockquote>

<p>x264 中关于模式 Intra_4x4_Vertical_Left 的代码如下：</p>

<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="c"><span class="line"><span class="k">static</span> <span class="kt">void</span> <span class="nf">x264_predict_4x4_vl_c</span><span class="p">(</span> <span class="n">pixel</span> <span class="o">*</span><span class="n">src</span> <span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">PREDICT_4x4_LOAD_TOP</span>
</span><span class="line">    <span class="n">PREDICT_4x4_LOAD_TOP_RIGHT</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span> <span class="n">F1</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span><span class="n">t1</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span> <span class="n">F1</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">t3</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span> <span class="n">F1</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span><span class="n">t3</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span><span class="n">t3</span><span class="p">,</span><span class="n">t4</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span> <span class="n">F1</span><span class="p">(</span><span class="n">t3</span><span class="p">,</span><span class="n">t4</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t3</span><span class="p">,</span><span class="n">t4</span><span class="p">,</span><span class="n">t5</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span> <span class="n">F1</span><span class="p">(</span><span class="n">t4</span><span class="p">,</span><span class="n">t5</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t4</span><span class="p">,</span><span class="n">t5</span><span class="p">,</span><span class="n">t6</span><span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h3 id="intra4x4horizontalup-">Intra_4x4_Horizontal_Up 预测模式</h3>

<p>在 SPEC 中，关于该预测模式的定义如下：</p>

<blockquote><p>This Intra_4x4 prediction mode is invoked when Intra4x4PredMode[ luma4x4BlkIdx ] is equal to 8.<br />This mode shall be used only when the samples p[ −1, y ] with y = 0..3 are marked as "available for Intra_4x4 prediction".<br />Let the variable zHU be set equal to x + 2 * y.<br />The values of the prediction samples $pred4x4_L[ x, y ]$, with x, y = 0..3, are derived as follows:</p></blockquote>

<p>x264 中关于模式 Intra_4x4_Horizontal_Up 的代码如下：</p>

<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="c"><span class="line"><span class="k">static</span> <span class="kt">void</span> <span class="nf">x264_predict_4x4_hu_c</span><span class="p">(</span> <span class="n">pixel</span> <span class="o">*</span><span class="n">src</span> <span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">PREDICT_4x4_LOAD_LEFT</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span> <span class="n">F1</span><span class="p">(</span><span class="n">l0</span><span class="p">,</span><span class="n">l1</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">l0</span><span class="p">,</span><span class="n">l1</span><span class="p">,</span><span class="n">l2</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span> <span class="n">F1</span><span class="p">(</span><span class="n">l1</span><span class="p">,</span><span class="n">l2</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">l1</span><span class="p">,</span><span class="n">l2</span><span class="p">,</span><span class="n">l3</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span> <span class="n">F1</span><span class="p">(</span><span class="n">l2</span><span class="p">,</span><span class="n">l3</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">l2</span><span class="p">,</span><span class="n">l3</span><span class="p">,</span><span class="n">l3</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span> <span class="n">l3</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2 id="intra8x8-">Intra_8x8 预测模式</h2>

<p>x264 中对 8x8 的预测模式如下：</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">intra8x8Predmodei[luma8x8BlkIdx]</th>
      <th style="text-align: center">Name of Intra8x8PredMode[luma8x8BlkIdx]</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">0</td>
      <td style="text-align: center">Intra_8x8_Vertical(prediction mode)</td>
    </tr>
    <tr>
      <td style="text-align: center">1</td>
      <td style="text-align: center">Intra_8x8_Horizontal(prediction mode)</td>
    </tr>
    <tr>
      <td style="text-align: center">2</td>
      <td style="text-align: center">Intra_8x8_DC(prediction mode)</td>
    </tr>
    <tr>
      <td style="text-align: center">3</td>
      <td style="text-align: center">Intra_8x8_Diagonal_Down_Left(prediction mode)</td>
    </tr>
    <tr>
      <td style="text-align: center">4</td>
      <td style="text-align: center">Intra_8x8_Diagonal_Down_Right(prediction mode)</td>
    </tr>
    <tr>
      <td style="text-align: center">5</td>
      <td style="text-align: center">Intra_8x8_Vertical_Right(prediction mode)</td>
    </tr>
    <tr>
      <td style="text-align: center">6</td>
      <td style="text-align: center">Intra_8x8_Horizontal_Down(prediction mode)</td>
    </tr>
    <tr>
      <td style="text-align: center">7</td>
      <td style="text-align: center">Intra_8x8_Vertical_Left(prediction mode)</td>
    </tr>
    <tr>
      <td style="text-align: center">8</td>
      <td style="text-align: center">Intra_8x8_Horizontal_Up(prediction mode)</td>
    </tr>
  </tbody>
</table>

<p>下面依次分析这几种预测模式：</p>

<h3 id="intra8x8vertical-">Intra_8x8_Vertical 预测模式</h3>

<p>在 SPEC 中，关于该预测模式的定义如下：</p>

<blockquote><p>This Intra_8x8 prediction mode is invoked when Intra8x8PredMode[ luma8x8BlkIdx ] is equal to 0.<br />This mode shall be used only when the samples p[ x, -1 ] with x = 0..7 are marked as "available for Intra_8x8 prediction".<br />The values of the prediction samples $pred8x8_L[ x, y ]$, with x, y = 0..7, are derived by   <br />$pred8x8_L[x,y]=p'[x,-1],with x,y=0..7$</p></blockquote>

<p>X264 中关于模式 Intra_8x8_Vertical 的代码如下：</p>

<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="c"><span class="line"><span class="kt">void</span> <span class="nf">x264_predict_8x8_v_c</span><span class="p">(</span> <span class="n">pixel</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">pixel</span> <span class="n">edge</span><span class="p">[</span><span class="mi">36</span><span class="p">]</span> <span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">pixel4</span> <span class="n">top</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">MPIXEL_X4</span><span class="p">(</span> <span class="n">edge</span><span class="o">+</span><span class="mi">16</span> <span class="p">),</span>
</span><span class="line">                      <span class="n">MPIXEL_X4</span><span class="p">(</span> <span class="n">edge</span><span class="o">+</span><span class="mi">20</span> <span class="p">)</span> <span class="p">};</span>
</span><span class="line">    <span class="k">for</span><span class="p">(</span> <span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span> <span class="p">)</span>
</span><span class="line">    <span class="p">{</span>
</span><span class="line">        <span class="n">MPIXEL_X4</span><span class="p">(</span> <span class="n">src</span><span class="o">+</span><span class="n">y</span><span class="o">*</span><span class="n">FDEC_STRIDE</span><span class="o">+</span><span class="mi">0</span> <span class="p">)</span> <span class="o">=</span> <span class="n">top</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class="line">        <span class="n">MPIXEL_X4</span><span class="p">(</span> <span class="n">src</span><span class="o">+</span><span class="n">y</span><span class="o">*</span><span class="n">FDEC_STRIDE</span><span class="o">+</span><span class="mi">4</span> <span class="p">)</span> <span class="o">=</span> <span class="n">top</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h3 id="intra8x8horizontal-">Intra_8x8_Horizontal 预测模式</h3>

<p>在SPEC 中，关于该预测模式的定义如下：</p>

<blockquote><p>This Intra_8x8 prediction mode is invoked when Intra8x8PredMode[ luma8x8BlkIdx ] is equal to 1.<br />This mode shall be used only when the samples p[ −1, y ], with y = 0..7, are marked as "available for Intra_8x8 prediction".<br />The values of the prediction samples $pred8x8_L[ x, y ]$, with x, y = 0..7, are derived by  <br />$pred8x8_L[x,y]=p'[-1,y], with x,y=0..7$</p></blockquote>

<p>x264 中对 Intra_8x8_Horizontal 的代码如下：</p>

<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
</pre></td><td class="code"><pre><code class="c"><span class="line"><span class="cp">#define PL(y) \</span>
</span><span class="line"><span class="cp">    UNUSED int l##y = edge[14-y];</span>
</span><span class="line"><span class="cp">#define PT(x) \</span>
</span><span class="line"><span class="cp">    UNUSED int t##x = edge[16+x];</span>
</span><span class="line"><span class="cp">#define PREDICT_8x8_LOAD_TOPLEFT \</span>
</span><span class="line"><span class="cp">    int lt = edge[15];</span>
</span><span class="line"><span class="cp">#define PREDICT_8x8_LOAD_LEFT \</span>
</span><span class="line"><span class="cp">    PL(0) PL(1) PL(2) PL(3) PL(4) PL(5) PL(6) PL(7)</span>
</span><span class="line"><span class="cp">#define PREDICT_8x8_LOAD_TOP \</span>
</span><span class="line"><span class="cp">    PT(0) PT(1) PT(2) PT(3) PT(4) PT(5) PT(6) PT(7)</span>
</span><span class="line"><span class="cp">#define PREDICT_8x8_LOAD_TOPRIGHT \</span>
</span><span class="line"><span class="cp">    PT(8) PT(9) PT(10) PT(11) PT(12) PT(13) PT(14) PT(15)</span>
</span><span class="line">
</span><span class="line"><span class="cp">#define PREDICT_8x8_DC(v) \</span>
</span><span class="line"><span class="cp">    for( int y = 0; y &lt; 8; y++ ) { \</span>
</span><span class="line"><span class="cp">        MPIXEL_X4( src+0 ) = v; \</span>
</span><span class="line"><span class="cp">        MPIXEL_X4( src+4 ) = v; \</span>
</span><span class="line"><span class="cp">        src += FDEC_STRIDE; \</span>
</span><span class="line"><span class="cp">    }</span>
</span><span class="line">
</span><span class="line"><span class="kt">void</span> <span class="nf">x264_predict_8x8_h_c</span><span class="p">(</span> <span class="n">pixel</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">pixel</span> <span class="n">edge</span><span class="p">[</span><span class="mi">36</span><span class="p">]</span> <span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">PREDICT_8x8_LOAD_LEFT</span>
</span><span class="line"><span class="cp">#define ROW(y) MPIXEL_X4( src+y*FDEC_STRIDE+0 ) =\</span>
</span><span class="line"><span class="cp">               MPIXEL_X4( src+y*FDEC_STRIDE+4 ) = PIXEL_SPLAT_X4( l##y );</span>
</span><span class="line">    <span class="n">ROW</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="n">ROW</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="n">ROW</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="n">ROW</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span> <span class="n">ROW</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span> <span class="n">ROW</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span> <span class="n">ROW</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span> <span class="n">ROW</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
</span><span class="line"><span class="cp">#undef ROW</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h3 id="intra8x8dc-">Intra_8x8_DC 预测模式</h3>

<p>在SPEC 中，关于该预测模式的定义如下：</p>

<blockquote><p>This Intra_8x8 prediction mode is invoked when Intra8x8PredMode[ luma8x8BlkIdx ] is equal to 2.<br />The values of the prediction samples $pred8x8_L[ x, y ]$, with x, y = 0..7, are derived as follows:</p></blockquote>

<p>x264 中对 Intra_8x8_DC 模式的代码如下：</p>

<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
</pre></td><td class="code"><pre><code class="c"><span class="line"><span class="k">static</span> <span class="kt">void</span> <span class="nf">x264_predict_8x8_dc_128_c</span><span class="p">(</span> <span class="n">pixel</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">pixel</span> <span class="n">edge</span><span class="p">[</span><span class="mi">36</span><span class="p">]</span> <span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">PREDICT_8x8_DC</span><span class="p">(</span> <span class="n">PIXEL_SPLAT_X4</span><span class="p">(</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">BIT_DEPTH</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line"><span class="k">static</span> <span class="kt">void</span> <span class="nf">x264_predict_8x8_dc_left_c</span><span class="p">(</span> <span class="n">pixel</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">pixel</span> <span class="n">edge</span><span class="p">[</span><span class="mi">36</span><span class="p">]</span> <span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">PREDICT_8x8_LOAD_LEFT</span>
</span><span class="line">    <span class="n">pixel4</span> <span class="n">dc</span> <span class="o">=</span> <span class="n">PIXEL_SPLAT_X4</span><span class="p">(</span> <span class="p">(</span><span class="n">l0</span><span class="o">+</span><span class="n">l1</span><span class="o">+</span><span class="n">l2</span><span class="o">+</span><span class="n">l3</span><span class="o">+</span><span class="n">l4</span><span class="o">+</span><span class="n">l5</span><span class="o">+</span><span class="n">l6</span><span class="o">+</span><span class="n">l7</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span> <span class="p">);</span>
</span><span class="line">    <span class="n">PREDICT_8x8_DC</span><span class="p">(</span> <span class="n">dc</span> <span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line"><span class="k">static</span> <span class="kt">void</span> <span class="nf">x264_predict_8x8_dc_top_c</span><span class="p">(</span> <span class="n">pixel</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">pixel</span> <span class="n">edge</span><span class="p">[</span><span class="mi">36</span><span class="p">]</span> <span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">PREDICT_8x8_LOAD_TOP</span>
</span><span class="line">    <span class="n">pixel4</span> <span class="n">dc</span> <span class="o">=</span> <span class="n">PIXEL_SPLAT_X4</span><span class="p">(</span> <span class="p">(</span><span class="n">t0</span><span class="o">+</span><span class="n">t1</span><span class="o">+</span><span class="n">t2</span><span class="o">+</span><span class="n">t3</span><span class="o">+</span><span class="n">t4</span><span class="o">+</span><span class="n">t5</span><span class="o">+</span><span class="n">t6</span><span class="o">+</span><span class="n">t7</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span> <span class="p">);</span>
</span><span class="line">    <span class="n">PREDICT_8x8_DC</span><span class="p">(</span> <span class="n">dc</span> <span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line"><span class="kt">void</span> <span class="nf">x264_predict_8x8_dc_c</span><span class="p">(</span> <span class="n">pixel</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">pixel</span> <span class="n">edge</span><span class="p">[</span><span class="mi">36</span><span class="p">]</span> <span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">PREDICT_8x8_LOAD_LEFT</span>
</span><span class="line">    <span class="n">PREDICT_8x8_LOAD_TOP</span>
</span><span class="line">    <span class="n">pixel4</span> <span class="n">dc</span> <span class="o">=</span> <span class="n">PIXEL_SPLAT_X4</span><span class="p">(</span> <span class="p">(</span><span class="n">l0</span><span class="o">+</span><span class="n">l1</span><span class="o">+</span><span class="n">l2</span><span class="o">+</span><span class="n">l3</span><span class="o">+</span><span class="n">l4</span><span class="o">+</span><span class="n">l5</span><span class="o">+</span><span class="n">l6</span><span class="o">+</span><span class="n">l7</span><span class="o">+</span><span class="n">t0</span><span class="o">+</span><span class="n">t1</span><span class="o">+</span><span class="n">t2</span><span class="o">+</span><span class="n">t3</span><span class="o">+</span><span class="n">t4</span><span class="o">+</span><span class="n">t5</span><span class="o">+</span><span class="n">t6</span><span class="o">+</span><span class="n">t7</span><span class="o">+</span><span class="mi">8</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="p">);</span>
</span><span class="line">    <span class="n">PREDICT_8x8_DC</span><span class="p">(</span> <span class="n">dc</span> <span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h3 id="intra8x8diagonaldownleft-">Intra_8x8_Diagonal_Down_Left 预测模式</h3>

<p>在SPEC 中，关于该预测模式的定义如下：</p>

<blockquote><p>This Intra_8x8 prediction mode is invoked when Intra8x8PredMode[ luma8x8BlkIdx ] is equal to 3.<br />This mode shall be used only when the samples p[ x, −1 ] with x = 0..15 are marked as "available for Intra_8x8 prediction".<br />The values of the prediction samples $pred8x8_L[ x, y ]$, with x, y = 0..7, are derived as follows:  <br />If x is equal to 7 and y is equal to 7,  <br />$pred8xx_L[x,y]=( p′[ 14, −1 ] + 3 * p′[ 15, −1 ] + 2 ) &gt;&gt; 2$<br />Otherwise (x is not equal to 7 or y is not equal to 7)  <br />$pred8x8_L[ x, y ] = ( p′[ x + y, −1 ] + 2 * p′[ x + y + 1, −1 ] + p′[ x + y + 2, −1 ] + 2 ) &gt;&gt; 2$</p></blockquote>

<p>X264 中关于模式 Intra_8x8_Diagonal_Down_Left 的代码如下：</p>

<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="c"><span class="line"><span class="k">static</span> <span class="kt">void</span> <span class="nf">x264_predict_8x8_ddl_c</span><span class="p">(</span> <span class="n">pixel</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">pixel</span> <span class="n">edge</span><span class="p">[</span><span class="mi">36</span><span class="p">]</span> <span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">PREDICT_8x8_LOAD_TOP</span>
</span><span class="line">    <span class="n">PREDICT_8x8_LOAD_TOPRIGHT</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">t3</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span><span class="n">t3</span><span class="p">,</span><span class="n">t4</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t3</span><span class="p">,</span><span class="n">t4</span><span class="p">,</span><span class="n">t5</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t4</span><span class="p">,</span><span class="n">t5</span><span class="p">,</span><span class="n">t6</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t5</span><span class="p">,</span><span class="n">t6</span><span class="p">,</span><span class="n">t7</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t6</span><span class="p">,</span><span class="n">t7</span><span class="p">,</span><span class="n">t8</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t7</span><span class="p">,</span><span class="n">t8</span><span class="p">,</span><span class="n">t9</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t8</span><span class="p">,</span><span class="n">t9</span><span class="p">,</span><span class="n">t10</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t9</span><span class="p">,</span><span class="n">t10</span><span class="p">,</span><span class="n">t11</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t10</span><span class="p">,</span><span class="n">t11</span><span class="p">,</span><span class="n">t12</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t11</span><span class="p">,</span><span class="n">t12</span><span class="p">,</span><span class="n">t13</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t12</span><span class="p">,</span><span class="n">t13</span><span class="p">,</span><span class="n">t14</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t13</span><span class="p">,</span><span class="n">t14</span><span class="p">,</span><span class="n">t15</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t14</span><span class="p">,</span><span class="n">t15</span><span class="p">,</span><span class="n">t15</span><span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h3 id="intra8x8diagonaldownright-">Intra_8x8_Diagonal_Down_Right 预测模式</h3>

<p>在SPEC 中，关于该预测模式的定义如下：</p>

<blockquote><p>This Intra_8x8 prediction mode is invoked when Intra8x8PredMode[ luma8x8BlkIdx ] is equal to 4.<br />This mode shall be used only when the samples p[ x, .1 ] with x = 0..7 and p[ .1, y ] with y = .1..7 are marked as<br />"available for Intra_8x8 prediction".<br />The values of the prediction samples $pred8x8_L[ x, y ]$, with x, y = 0..7, are derived as follows:  <br />If x is greater than y,<br />$pred8x8_L[ x, y ] = ( p′[ x − y − 2, −1] + 2 * p′[ x − y − 1, −1 ] + p′[ x − y, −1 ] + 2 ) &gt;&gt; 2$<br />Otherwise if x is less than y,<br />$pred8x8_L[ x, y ] = ( p′[ .1, y . x . 2 ] + 2 * p′[ .1, y . x . 1 ] + p′[ .1, y . x ] + 2 ) &gt;&gt; 2$<br />Otherwise (x is equal to y),<br />$pred8x8_L[ x, y ] = ( p′[ 0, −1 ] + 2 * p′[ −1, −1 ] + p′[ −1, 0 ] + 2 ) &gt;&gt; 2$</p></blockquote>

<p>X264 中关于模式 Intra_8x8_Diagonal_Down_Right 的代码如下：</p>

<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
</pre></td><td class="code"><pre><code class="c"><span class="line"><span class="k">static</span> <span class="kt">void</span> <span class="nf">x264_predict_8x8_ddr_c</span><span class="p">(</span> <span class="n">pixel</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">pixel</span> <span class="n">edge</span><span class="p">[</span><span class="mi">36</span><span class="p">]</span> <span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">PREDICT_8x8_LOAD_TOP</span>
</span><span class="line">    <span class="n">PREDICT_8x8_LOAD_LEFT</span>
</span><span class="line">    <span class="n">PREDICT_8x8_LOAD_TOPLEFT</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">l7</span><span class="p">,</span><span class="n">l6</span><span class="p">,</span><span class="n">l5</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">l6</span><span class="p">,</span><span class="n">l5</span><span class="p">,</span><span class="n">l4</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">l5</span><span class="p">,</span><span class="n">l4</span><span class="p">,</span><span class="n">l3</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">l4</span><span class="p">,</span><span class="n">l3</span><span class="p">,</span><span class="n">l2</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">l3</span><span class="p">,</span><span class="n">l2</span><span class="p">,</span><span class="n">l1</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">l2</span><span class="p">,</span><span class="n">l1</span><span class="p">,</span><span class="n">l0</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">l1</span><span class="p">,</span><span class="n">l0</span><span class="p">,</span><span class="n">lt</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">l0</span><span class="p">,</span><span class="n">lt</span><span class="p">,</span><span class="n">t0</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">lt</span><span class="p">,</span><span class="n">t0</span><span class="p">,</span><span class="n">t1</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">t3</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span><span class="n">t3</span><span class="p">,</span><span class="n">t4</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t3</span><span class="p">,</span><span class="n">t4</span><span class="p">,</span><span class="n">t5</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t4</span><span class="p">,</span><span class="n">t5</span><span class="p">,</span><span class="n">t6</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t5</span><span class="p">,</span><span class="n">t6</span><span class="p">,</span><span class="n">t7</span><span class="p">);</span>
</span><span class="line">
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h3 id="intra8x8verticalright-">Intra_8x8_Vertical_Right 预测模式</h3>

<p>在SPEC 中，关于该预测模式的定义如下：</p>

<blockquote><p>This Intra_8x8 prediction mode is invoked when Intra8x8PredMode[ luma8x8BlkIdx ] is equal to 5.<br />This mode shall be used only when the samples p[ x, -1 ] with x = 0..7 and p[ -1, y ] with y = -1..7 are marked as "available for Intra_8x8 prediction".<br />Let the variable zVR be set equal to 2 * x . y.<br />The values of the prediction samples $pred8x8_L[ x, y ]$, with x, y = 0..7, are derived as follows:  <br />If zVR is equal to 0, 2, 4, 6, 8, 10, 12, or 14  <br />$pred8x8_L[x,y] = (p'[x-y(y&gt;&gt;1)-1,-1] + p'[x-(y&gt;&gt;1),-1]+1)&gt;&gt;1$  <br />Otherwise, if zVR is equal to 1, 3, 5, 7, 9, 11, or 13  <br />$pred8x8_L[x,y]=(p'[x-(y&gt;&gt;1)-2,-1]+2*p'[x-(y&gt;&gt;1)-1,-1]+p'[x-(y&gt;&gt;1),-1]+2)&gt;&gt;2$  <br />Otherwise, if zVR is equal to −1,  <br />$pred8x8_L[ x, y ] = ( p′[ −1, 0 ] + 2 * p′[ −1, −1 ] + p′[ 0, −1 ] + 2 ) &gt;&gt; 2$  <br />Otherwise (zVR is equal to .2, .3, .4, .5, .6, or .7),  <br />$pred8x8_L[ x, y ] = ( p′[ -1, y . 2*x - 1 ] + 2 * p′[ -1, y - 2*x - 2 ] + p′[ -1, y - 2*x - 3 ] + 2 ) &gt;&gt; 2$</p></blockquote>

<p>X264 中关于模式 Intra_8x8_Vertical_Right 的代码如下：</p>

<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
</pre></td><td class="code"><pre><code class="c"><span class="line"><span class="k">static</span> <span class="kt">void</span> <span class="nf">x264_predict_8x8_vr_c</span><span class="p">(</span> <span class="n">pixel</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">pixel</span> <span class="n">edge</span><span class="p">[</span><span class="mi">36</span><span class="p">]</span> <span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">PREDICT_8x8_LOAD_TOP</span>
</span><span class="line">    <span class="n">PREDICT_8x8_LOAD_LEFT</span>
</span><span class="line">    <span class="n">PREDICT_8x8_LOAD_TOPLEFT</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">l5</span><span class="p">,</span><span class="n">l4</span><span class="p">,</span><span class="n">l3</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">l6</span><span class="p">,</span><span class="n">l5</span><span class="p">,</span><span class="n">l4</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">l3</span><span class="p">,</span><span class="n">l2</span><span class="p">,</span><span class="n">l1</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">l4</span><span class="p">,</span><span class="n">l3</span><span class="p">,</span><span class="n">l2</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">l1</span><span class="p">,</span><span class="n">l0</span><span class="p">,</span><span class="n">lt</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">l2</span><span class="p">,</span><span class="n">l1</span><span class="p">,</span><span class="n">l0</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">l0</span><span class="p">,</span><span class="n">lt</span><span class="p">,</span><span class="n">t0</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span> <span class="n">F1</span><span class="p">(</span><span class="n">lt</span><span class="p">,</span><span class="n">t0</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">lt</span><span class="p">,</span><span class="n">t0</span><span class="p">,</span><span class="n">t1</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span> <span class="n">F1</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span><span class="n">t1</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span> <span class="n">F1</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">t3</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span> <span class="n">F1</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span><span class="n">t3</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span><span class="n">t3</span><span class="p">,</span><span class="n">t4</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span> <span class="n">F1</span><span class="p">(</span><span class="n">t3</span><span class="p">,</span><span class="n">t4</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t3</span><span class="p">,</span><span class="n">t4</span><span class="p">,</span><span class="n">t5</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span> <span class="n">F1</span><span class="p">(</span><span class="n">t4</span><span class="p">,</span><span class="n">t5</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t4</span><span class="p">,</span><span class="n">t5</span><span class="p">,</span><span class="n">t6</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span> <span class="n">F1</span><span class="p">(</span><span class="n">t5</span><span class="p">,</span><span class="n">t6</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t5</span><span class="p">,</span><span class="n">t6</span><span class="p">,</span><span class="n">t7</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span> <span class="n">F1</span><span class="p">(</span><span class="n">t6</span><span class="p">,</span><span class="n">t7</span><span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h3 id="intra8x8horizontaldown-">Intra_8x8_Horizontal_Down 预测模式</h3>

<p>在SPEC 中，关于该预测模式的定义如下：</p>

<blockquote><p>This Intra_8x8 prediction mode is invoked when Intra8x8PredMode[ luma8x8BlkIdx ] is equal to 6.<br />This mode shall be used only when the samples p[ x, −1 ] with x = 0..7 and p[ −1, y ] with y = −1..7 are marked as "available for Intra_8x8 prediction".<br />Let the variable zHD be set equal to 2 * y − x.<br />The values of the prediction samples $pred8x8_L[ x, y ]$, with x, y = 0..7, are derived as follows:  <br />If zHD is equal to 0, 2, 4, 6, 8, 10, 12, or 14  <br />$pred8x8_L[ x, y ] = ( p′[ −1, y − ( x &gt;&gt; 1 ) − 1 ] + p′[ −1, y − ( x &gt;&gt; 1 ) ] + 1 ) &gt;&gt; 1$  <br />Otherwise, if zHD is equal to 1, 3, 5, 7, 9, 11, or 13  <br />$pred8x8_L[x,y]=(p′[-1, y -(x&gt;&gt;1)-2]+2*p′[-1,y-(x&gt;&gt;1)-1]+p′[-1,y-(x&gt;&gt;1)]+2)&gt;&gt;2$<br />Otherwise, if zHD is equal to −1,<br />$pred8x8L[ x, y ] = ( p′[ −1, 0 ] + 2 * p′[ −1, −1 ] + p′[ 0, −1 ] + 2 ) &gt;&gt; 2$<br />Otherwise (zHD is equal to −2, −3, −4, −5, −6, −7),<br />$pred8x8L[ x, y ] = ( p′[ x − 2*y − 1, −1 ] + 2 * p′[ x − 2*y − 2, −1 ] + p′[ x − 2*y − 3, −1 ] + 2 ) &gt;&gt; 2$</p></blockquote>

<p>X264 中关于模式 Intra_8x8_Horizontal_Down 的代码如下：</p>

<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
</pre></td><td class="code"><pre><code class="c"><span class="line"><span class="k">static</span> <span class="kt">void</span> <span class="nf">x264_predict_8x8_hd_c</span><span class="p">(</span> <span class="n">pixel</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">pixel</span> <span class="n">edge</span><span class="p">[</span><span class="mi">36</span><span class="p">]</span> <span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">PREDICT_8x8_LOAD_TOP</span>
</span><span class="line">    <span class="n">PREDICT_8x8_LOAD_LEFT</span>
</span><span class="line">    <span class="n">PREDICT_8x8_LOAD_TOPLEFT</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">pack_pixel_1to2</span><span class="p">(</span><span class="n">F1</span><span class="p">(</span><span class="n">l6</span><span class="p">,</span><span class="n">l7</span><span class="p">),</span> <span class="n">F2</span><span class="p">(</span><span class="n">l5</span><span class="p">,</span><span class="n">l6</span><span class="p">,</span><span class="n">l7</span><span class="p">));</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">pack_pixel_1to2</span><span class="p">(</span><span class="n">F1</span><span class="p">(</span><span class="n">l5</span><span class="p">,</span><span class="n">l6</span><span class="p">),</span> <span class="n">F2</span><span class="p">(</span><span class="n">l4</span><span class="p">,</span><span class="n">l5</span><span class="p">,</span><span class="n">l6</span><span class="p">));</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">p3</span> <span class="o">=</span> <span class="n">pack_pixel_1to2</span><span class="p">(</span><span class="n">F1</span><span class="p">(</span><span class="n">l4</span><span class="p">,</span><span class="n">l5</span><span class="p">),</span> <span class="n">F2</span><span class="p">(</span><span class="n">l3</span><span class="p">,</span><span class="n">l4</span><span class="p">,</span><span class="n">l5</span><span class="p">));</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">p4</span> <span class="o">=</span> <span class="n">pack_pixel_1to2</span><span class="p">(</span><span class="n">F1</span><span class="p">(</span><span class="n">l3</span><span class="p">,</span><span class="n">l4</span><span class="p">),</span> <span class="n">F2</span><span class="p">(</span><span class="n">l2</span><span class="p">,</span><span class="n">l3</span><span class="p">,</span><span class="n">l4</span><span class="p">));</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">p5</span> <span class="o">=</span> <span class="n">pack_pixel_1to2</span><span class="p">(</span><span class="n">F1</span><span class="p">(</span><span class="n">l2</span><span class="p">,</span><span class="n">l3</span><span class="p">),</span> <span class="n">F2</span><span class="p">(</span><span class="n">l1</span><span class="p">,</span><span class="n">l2</span><span class="p">,</span><span class="n">l3</span><span class="p">));</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">p6</span> <span class="o">=</span> <span class="n">pack_pixel_1to2</span><span class="p">(</span><span class="n">F1</span><span class="p">(</span><span class="n">l1</span><span class="p">,</span><span class="n">l2</span><span class="p">),</span> <span class="n">F2</span><span class="p">(</span><span class="n">l0</span><span class="p">,</span><span class="n">l1</span><span class="p">,</span><span class="n">l2</span><span class="p">));</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">p7</span> <span class="o">=</span> <span class="n">pack_pixel_1to2</span><span class="p">(</span><span class="n">F1</span><span class="p">(</span><span class="n">l0</span><span class="p">,</span><span class="n">l1</span><span class="p">),</span> <span class="n">F2</span><span class="p">(</span><span class="n">lt</span><span class="p">,</span><span class="n">l0</span><span class="p">,</span><span class="n">l1</span><span class="p">));</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">p8</span> <span class="o">=</span> <span class="n">pack_pixel_1to2</span><span class="p">(</span><span class="n">F1</span><span class="p">(</span><span class="n">lt</span><span class="p">,</span><span class="n">l0</span><span class="p">),</span> <span class="n">F2</span><span class="p">(</span><span class="n">l0</span><span class="p">,</span><span class="n">lt</span><span class="p">,</span><span class="n">t0</span><span class="p">));</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">p9</span> <span class="o">=</span> <span class="n">pack_pixel_1to2</span><span class="p">(</span><span class="n">F2</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">t0</span><span class="p">,</span><span class="n">lt</span><span class="p">),</span> <span class="n">F2</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t0</span><span class="p">));</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">p10</span> <span class="o">=</span> <span class="n">pack_pixel_1to2</span><span class="p">(</span><span class="n">F2</span><span class="p">(</span><span class="n">t3</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">t1</span><span class="p">),</span> <span class="n">F2</span><span class="p">(</span><span class="n">t4</span><span class="p">,</span><span class="n">t3</span><span class="p">,</span><span class="n">t2</span><span class="p">));</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">p11</span> <span class="o">=</span> <span class="n">pack_pixel_1to2</span><span class="p">(</span><span class="n">F2</span><span class="p">(</span><span class="n">t5</span><span class="p">,</span><span class="n">t4</span><span class="p">,</span><span class="n">t3</span><span class="p">),</span> <span class="n">F2</span><span class="p">(</span><span class="n">t6</span><span class="p">,</span><span class="n">t5</span><span class="p">,</span><span class="n">t4</span><span class="p">));</span>
</span><span class="line">    <span class="n">SRC_X4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">=</span> <span class="n">pack_pixel_2to4</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC_X4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span> <span class="n">pack_pixel_2to4</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span><span class="n">p3</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC_X4</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">=</span><span class="n">SRC_X4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span> <span class="n">pack_pixel_2to4</span><span class="p">(</span><span class="n">p3</span><span class="p">,</span><span class="n">p4</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC_X4</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span><span class="n">SRC_X4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span> <span class="n">pack_pixel_2to4</span><span class="p">(</span><span class="n">p4</span><span class="p">,</span><span class="n">p5</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC_X4</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span><span class="n">SRC_X4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span> <span class="n">pack_pixel_2to4</span><span class="p">(</span><span class="n">p5</span><span class="p">,</span><span class="n">p6</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC_X4</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span><span class="n">SRC_X4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span> <span class="n">pack_pixel_2to4</span><span class="p">(</span><span class="n">p6</span><span class="p">,</span><span class="n">p7</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC_X4</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span><span class="n">SRC_X4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span> <span class="n">pack_pixel_2to4</span><span class="p">(</span><span class="n">p7</span><span class="p">,</span><span class="n">p8</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC_X4</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC_X4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span> <span class="n">pack_pixel_2to4</span><span class="p">(</span><span class="n">p8</span><span class="p">,</span><span class="n">p9</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC_X4</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span> <span class="n">pack_pixel_2to4</span><span class="p">(</span><span class="n">p9</span><span class="p">,</span><span class="n">p10</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC_X4</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span> <span class="n">pack_pixel_2to4</span><span class="p">(</span><span class="n">p10</span><span class="p">,</span><span class="n">p11</span><span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h3 id="intra8x8verticalleft-">Intra_8x8_Vertical_Left 预测模式</h3>

<p>在SPEC 中，关于该预测模式的定义如下：</p>

<blockquote><p>This Intra_8x8 prediction mode is invoked when Intra8x8PredMode[ luma8x8BlkIdx ] is equal to 7.<br />This mode shall be used only when the samples p[ x, −1 ] with x = 0..15 are marked as "available for Intra_8x8 prediction".<br />The values of the prediction samples $pred8x8_L[ x, y ]$, with x, y = 0..7, are derived as follows:  <br />If y is equal to 0, 2, 4 or 6  <br />$pred8x8_L[ x, y ] = ( p′[ x + ( y &gt;&gt; 1 ), .1 ] + p′[ x + ( y &gt;&gt; 1 ) + 1, .1 ] + 1) &gt;&gt; 1$  <br />Otherwise (y is equal to 1, 3, 5, 7),  <br />$pred8x8_L[ x, y ] = ( p′[ x + ( y &gt;&gt; 1 ), −1 ] + 2 * p′[ x + ( y &gt;&gt; 1 ) + 1, −1 ] + p′[ x + ( y &gt;&gt; 1 ) + 2, −1 ] + 2 ) &gt;&gt;2$</p></blockquote>

<p>X264 中关于模式 Intra_8x8_Horizontal_Down 的代码如下：</p>

<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
</pre></td><td class="code"><pre><code class="c"><span class="line"><span class="k">static</span> <span class="kt">void</span> <span class="nf">x264_predict_8x8_vl_c</span><span class="p">(</span> <span class="n">pixel</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">pixel</span> <span class="n">edge</span><span class="p">[</span><span class="mi">36</span><span class="p">]</span> <span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">PREDICT_8x8_LOAD_TOP</span>
</span><span class="line">    <span class="n">PREDICT_8x8_LOAD_TOPRIGHT</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span> <span class="n">F1</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span><span class="n">t1</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span> <span class="n">F1</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">t3</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span> <span class="n">F1</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span><span class="n">t3</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span><span class="n">t3</span><span class="p">,</span><span class="n">t4</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span> <span class="n">F1</span><span class="p">(</span><span class="n">t3</span><span class="p">,</span><span class="n">t4</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t3</span><span class="p">,</span><span class="n">t4</span><span class="p">,</span><span class="n">t5</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span> <span class="n">F1</span><span class="p">(</span><span class="n">t4</span><span class="p">,</span><span class="n">t5</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t4</span><span class="p">,</span><span class="n">t5</span><span class="p">,</span><span class="n">t6</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span> <span class="n">F1</span><span class="p">(</span><span class="n">t5</span><span class="p">,</span><span class="n">t6</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t5</span><span class="p">,</span><span class="n">t6</span><span class="p">,</span><span class="n">t7</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span> <span class="n">F1</span><span class="p">(</span><span class="n">t6</span><span class="p">,</span><span class="n">t7</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t6</span><span class="p">,</span><span class="n">t7</span><span class="p">,</span><span class="n">t8</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span> <span class="n">F1</span><span class="p">(</span><span class="n">t7</span><span class="p">,</span><span class="n">t8</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t7</span><span class="p">,</span><span class="n">t8</span><span class="p">,</span><span class="n">t9</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span> <span class="n">F1</span><span class="p">(</span><span class="n">t8</span><span class="p">,</span><span class="n">t9</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t8</span><span class="p">,</span><span class="n">t9</span><span class="p">,</span><span class="n">t10</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span> <span class="n">F1</span><span class="p">(</span><span class="n">t9</span><span class="p">,</span><span class="n">t10</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">=</span><span class="n">SRC</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t9</span><span class="p">,</span><span class="n">t10</span><span class="p">,</span><span class="n">t11</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span> <span class="n">F1</span><span class="p">(</span><span class="n">t10</span><span class="p">,</span><span class="n">t11</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">=</span> <span class="n">F2</span><span class="p">(</span><span class="n">t10</span><span class="p">,</span><span class="n">t11</span><span class="p">,</span><span class="n">t12</span><span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h3 id="intra8x8horizontalup-">Intra_8x8_Horizontal_Up 预测模式</h3>

<p>在SPEC 中，关于该预测模式的定义如下：</p>

<blockquote><p>This Intra_8x8 prediction mode is invoked when Intra8x8PredMode[ luma8x8BlkIdx ] is equal to 8.<br />This mode shall be used only when the samples p[ -1, y ] with y = 0..7 are marked as "available for Intra_8x8 prediction".<br />Let the variable zHU be set equal to x + 2 * y.<br />The values of the prediction samples $pred8x8_L[ x, y ]$, with x, y = 0..7, are derived as follows:  <br />If zHU is equal to 0, 2, 4, 6, 8, 10, or 12  <br />$pred8x8_L[ x, y ] = ( p′[ −1, y + ( x &gt;&gt; 1 ) ] + p′[ −1, y + ( x &gt;&gt; 1 ) + 1 ] + 1 ) &gt;&gt; 1$<br />Otherwise, if zHU is equal to 1, 3, 5, 7, 9, or 11  <br />$pred8x8_L[ x, y ] = ( p′[ −1, y + ( x &gt;&gt; 1 ) ] + 2 * p′[ −1, y + ( x &gt;&gt; 1 ) + 1 ] + p′[ −1, y + ( x &gt;&gt; 1 ) + 2 ] + 2 ) &gt;&gt;2$<br />Otherwise, if zHU is equal to 13,  <br />$pred8x8_L[ x, y ] = ( p′[ −1, 6 ] + 3 * p′[ −1, 7 ] + 2 ) &gt;&gt; 2$  <br />Otherwise (zHU is greater than 13),  <br />$pred8x8_L[x,y]=p'[-1,7]$</p></blockquote>

<p>X264 中关于模式 Intra_8x8_Horizontal_Up 的代码如下：</p>

<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="c"><span class="line"><span class="k">static</span> <span class="kt">void</span> <span class="nf">x264_predict_8x8_hu_c</span><span class="p">(</span> <span class="n">pixel</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">pixel</span> <span class="n">edge</span><span class="p">[</span><span class="mi">36</span><span class="p">]</span> <span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">PREDICT_8x8_LOAD_LEFT</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">pack_pixel_1to2</span><span class="p">(</span><span class="n">F1</span><span class="p">(</span><span class="n">l0</span><span class="p">,</span><span class="n">l1</span><span class="p">),</span> <span class="n">F2</span><span class="p">(</span><span class="n">l0</span><span class="p">,</span><span class="n">l1</span><span class="p">,</span><span class="n">l2</span><span class="p">));</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">pack_pixel_1to2</span><span class="p">(</span><span class="n">F1</span><span class="p">(</span><span class="n">l1</span><span class="p">,</span><span class="n">l2</span><span class="p">),</span> <span class="n">F2</span><span class="p">(</span><span class="n">l1</span><span class="p">,</span><span class="n">l2</span><span class="p">,</span><span class="n">l3</span><span class="p">));</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">p3</span> <span class="o">=</span> <span class="n">pack_pixel_1to2</span><span class="p">(</span><span class="n">F1</span><span class="p">(</span><span class="n">l2</span><span class="p">,</span><span class="n">l3</span><span class="p">),</span> <span class="n">F2</span><span class="p">(</span><span class="n">l2</span><span class="p">,</span><span class="n">l3</span><span class="p">,</span><span class="n">l4</span><span class="p">));</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">p4</span> <span class="o">=</span> <span class="n">pack_pixel_1to2</span><span class="p">(</span><span class="n">F1</span><span class="p">(</span><span class="n">l3</span><span class="p">,</span><span class="n">l4</span><span class="p">),</span> <span class="n">F2</span><span class="p">(</span><span class="n">l3</span><span class="p">,</span><span class="n">l4</span><span class="p">,</span><span class="n">l5</span><span class="p">));</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">p5</span> <span class="o">=</span> <span class="n">pack_pixel_1to2</span><span class="p">(</span><span class="n">F1</span><span class="p">(</span><span class="n">l4</span><span class="p">,</span><span class="n">l5</span><span class="p">),</span> <span class="n">F2</span><span class="p">(</span><span class="n">l4</span><span class="p">,</span><span class="n">l5</span><span class="p">,</span><span class="n">l6</span><span class="p">));</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">p6</span> <span class="o">=</span> <span class="n">pack_pixel_1to2</span><span class="p">(</span><span class="n">F1</span><span class="p">(</span><span class="n">l5</span><span class="p">,</span><span class="n">l6</span><span class="p">),</span> <span class="n">F2</span><span class="p">(</span><span class="n">l5</span><span class="p">,</span><span class="n">l6</span><span class="p">,</span><span class="n">l7</span><span class="p">));</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">p7</span> <span class="o">=</span> <span class="n">pack_pixel_1to2</span><span class="p">(</span><span class="n">F1</span><span class="p">(</span><span class="n">l6</span><span class="p">,</span><span class="n">l7</span><span class="p">),</span> <span class="n">F2</span><span class="p">(</span><span class="n">l6</span><span class="p">,</span><span class="n">l7</span><span class="p">,</span><span class="n">l7</span><span class="p">));</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">p8</span> <span class="o">=</span> <span class="n">pack_pixel_1to2</span><span class="p">(</span><span class="n">l7</span><span class="p">,</span><span class="n">l7</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC_X4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span> <span class="n">pack_pixel_2to4</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC_X4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span> <span class="n">pack_pixel_2to4</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span><span class="n">p3</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC_X4</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="n">SRC_X4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span> <span class="n">pack_pixel_2to4</span><span class="p">(</span><span class="n">p3</span><span class="p">,</span><span class="n">p4</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC_X4</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">SRC_X4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span> <span class="n">pack_pixel_2to4</span><span class="p">(</span><span class="n">p4</span><span class="p">,</span><span class="n">p5</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC_X4</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">SRC_X4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span> <span class="n">pack_pixel_2to4</span><span class="p">(</span><span class="n">p5</span><span class="p">,</span><span class="n">p6</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC_X4</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span><span class="n">SRC_X4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span> <span class="n">pack_pixel_2to4</span><span class="p">(</span><span class="n">p6</span><span class="p">,</span><span class="n">p7</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC_X4</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span><span class="n">SRC_X4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span> <span class="n">pack_pixel_2to4</span><span class="p">(</span><span class="n">p7</span><span class="p">,</span><span class="n">p8</span><span class="p">);</span>
</span><span class="line">    <span class="n">SRC_X4</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span><span class="n">SRC_X4</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span> <span class="n">SRC_X4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">SRC_X4</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">pack_pixel_2to4</span><span class="p">(</span><span class="n">p8</span><span class="p">,</span><span class="n">p8</span><span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2 id="intra16x16-">Intra_16x16 预测模式</h2>

<p>x264 中对 16x16 的预测模式如下：</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">intra16x16Predmode</th>
      <th style="text-align: center">Name of Intra16x16PredMode</th>
      <th style="text-align: center">Note</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">0</td>
      <td style="text-align: center">Intra_16x16_Vertical(prediction mode)</td>
      <td style="text-align: center">由上边像素推出相应像素值</td>
    </tr>
    <tr>
      <td style="text-align: center">1</td>
      <td style="text-align: center">Intra_16x16_Horicontal(prdiction mode)</td>
      <td style="text-align: center">由左边像素推出相应像素值</td>
    </tr>
    <tr>
      <td style="text-align: center">2</td>
      <td style="text-align: center">Intra_16x16_DC(prediction mode)</td>
      <td style="text-align: center">由上边和左边像素平均值推出相应像素值</td>
    </tr>
    <tr>
      <td style="text-align: center">3</td>
      <td style="text-align: center">Intra_16x16_Plane(prediction mode)</td>
      <td style="text-align: center">利用线性 plan 函数及左、上像素推出相应像素值，适用于亮度变化平缓区域</td>
    </tr>
  </tbody>
</table>

<p>下面依次分析这几种预测模式：</p>

<h3 id="intra16x16vertical-">Intra_16x16_Vertical 预测模式</h3>

<p>在 SPEC 中，关于该预测模式的定义如下：</p>

<blockquote><p>This Intra_16x16 prediction mode shall be used only when the samples p[x, -1] with x=0...15 are marked as "available for Intra_16x16 prediction".The values of the prediction samples pred[x, y] with x,y=0...15, are derived by pred[x,y]=p[x,-1],with x,y=0...15</p></blockquote>

<p>从 SPEC 中可以看出，只要<code>16x16</code>宏块正上方的 16 个元素可用，就可以使用使用<code>Intra_16x16_Vertical</code>预测模式，至于该宏块的左边像素是否可用，并不影响。示例如下：</p>

<p><img src="/images/x264_intra_predict/intra_16x16_vertical.png" /></p>

<p>x264 中关于模式 Vertical 的C 代码如下：</p>

<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="c"><span class="line"><span class="kt">void</span> <span class="nf">x264_predict_16x16_v_c</span><span class="p">(</span><span class="n">pixel</span> <span class="o">*</span><span class="n">src</span><span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="n">pixel4</span> <span class="n">v0</span> <span class="o">=</span> <span class="n">MPIXEL_X4</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">src</span><span class="p">[</span> <span class="mi">0</span><span class="o">-</span><span class="n">FDEC_STRIDE</span><span class="p">]</span> <span class="p">);</span>
</span><span class="line">    <span class="n">pixel4</span> <span class="n">v1</span> <span class="o">=</span> <span class="n">MPIXEL_X4</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">src</span><span class="p">[</span> <span class="mi">4</span><span class="o">-</span><span class="n">FDEC_STRIDE</span><span class="p">]</span> <span class="p">);</span>
</span><span class="line">    <span class="n">pixel4</span> <span class="n">v2</span> <span class="o">=</span> <span class="n">MPIXEL_X4</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">src</span><span class="p">[</span> <span class="mi">8</span><span class="o">-</span><span class="n">FDEC_STRIDE</span><span class="p">]</span> <span class="p">);</span>
</span><span class="line">    <span class="n">pixel4</span> <span class="n">v3</span> <span class="o">=</span> <span class="n">MPIXEL_X4</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">src</span><span class="p">[</span><span class="mi">12</span><span class="o">-</span><span class="n">FDEC_STRIDE</span><span class="p">]</span> <span class="p">);</span>
</span><span class="line">
</span><span class="line">    <span class="k">for</span><span class="p">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
</span><span class="line">    <span class="p">{</span>
</span><span class="line">        <span class="n">MPIXEL_X4</span><span class="p">(</span> <span class="n">src</span><span class="o">+</span> <span class="mi">0</span> <span class="p">)</span> <span class="o">=</span> <span class="n">v0</span><span class="p">;</span>
</span><span class="line">        <span class="n">MPIXEL_X4</span><span class="p">(</span> <span class="n">src</span><span class="o">+</span> <span class="mi">4</span> <span class="p">)</span> <span class="o">=</span> <span class="n">v1</span><span class="p">;</span>
</span><span class="line">        <span class="n">MPIXEL_X4</span><span class="p">(</span> <span class="n">src</span><span class="o">+</span> <span class="mi">8</span> <span class="p">)</span> <span class="o">=</span> <span class="n">v2</span><span class="p">;</span>
</span><span class="line">        <span class="n">MPIXEL_X4</span><span class="p">(</span> <span class="n">src</span><span class="o">+</span><span class="mi">12</span> <span class="p">)</span> <span class="o">=</span> <span class="n">v3</span><span class="p">;</span>
</span><span class="line">        <span class="n">src</span> <span class="o">+=</span> <span class="n">FDEC_STRIDE</span><span class="p">;</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>注意，上面代码中的 pixel 为 uint8_t，而 pixel4 为 uint32_t，而 MPIXEL_X4 定义如下：</p>

<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class=""><span class="line">#define MPIXEL_X4(src) M32(src)  
</span><span class="line">#deinfe M32(src) (((x264_union32_t *)(src))-&gt;i)  
</span><span class="line">typedef union { uint32_t i; uint16_t b[2]; uint8_t  c[4]; } MAY_ALIAS x264_union32_t;</span></code></pre></td></tr></table></div></figure>

<p>分析上面的代码结合上面的图，可以看出，每执行一次 for 循环，都对<code>16x16</code>的每一行像素进行赋值，而赋值的最小单位是4byte，一行像素需要4次赋值完成，值得大小就是宏块的上一行像素值得大小。
执行完整个 for 循环后，16x16 宏块像素赋值结束。</p>

<p>针对<code>AARCH64</code>平台，X264 做了汇编优化，其代码如下：</p>
<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class=""><span class="line">function x264_predict_16x16_v_neon, export=1
</span><span class="line">    sub     x0, x0, #FDEC_STRIDE
</span><span class="line">    mov     x7, #FDEC_STRIDE
</span><span class="line">    ldl     {v0.16b}, [x0], x7
</span><span class="line">.rept 16
</span><span class="line">    stl     {v0.16b}, [x0], x7
</span><span class="line">.endr
</span><span class="line">    ret
</span><span class="line">endfunc</span></code></pre></td></tr></table></div></figure>

<p>上面的汇编代码可以看出，同样是循环执行16次，因为是64位，所以每次赋值即可实现16字节的运算，相对于上面的C语言版，赋值语句是其1/4，实现了效率上的优化。</p>

<h3 id="intra16x16horizontal-">Intra_16x16_Horizontal 预测模式</h3>

<p>在 SPEC 中，关于该预测模式的定义如下：</p>

<blockquote><p>This Intra_16x16 prediction mode shall be used only when the samples p[−1, y] with y = 0..15 are marked as "available<br />for Intra_16x16 prediction".<br />The values of the prediction samples predL[ x, y ], with x, y = 0..15, are derived by<br />predL[ x, y ] = p[ −1, y ], with x, y = 0..15</p></blockquote>

<p>从 SPEC 中可以看出，只要<code>16x16</code>宏块左方的 16 个元素可用，就可以使用使用<code>Intra_16x16_Vertical</code>预测模式，至于该宏块的上边像素是否可用，并不影响。示例如下：</p>

<p><img src="/images/x264_intra_predict/intra_16x16_horizontal.png" /></p>

<p>x264 中关于模式 Horizontal 的代码如下：</p>

<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="c"><span class="line"><span class="kt">void</span> <span class="nf">x264_predict_16x16_h_c</span><span class="p">(</span> <span class="n">pixel</span> <span class="o">*</span><span class="n">src</span> <span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="k">for</span><span class="p">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
</span><span class="line">    <span class="p">{</span>
</span><span class="line">        <span class="k">const</span> <span class="n">pixel4</span> <span class="n">v</span> <span class="o">=</span> <span class="n">PIXEL_SPLAT_X4</span><span class="p">(</span> <span class="n">src</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">);</span>
</span><span class="line">        <span class="n">MPIXEL_X4</span><span class="p">(</span> <span class="n">src</span><span class="o">+</span> <span class="mi">0</span> <span class="p">)</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
</span><span class="line">        <span class="n">MPIXEL_X4</span><span class="p">(</span> <span class="n">src</span><span class="o">+</span> <span class="mi">4</span> <span class="p">)</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
</span><span class="line">        <span class="n">MPIXEL_X4</span><span class="p">(</span> <span class="n">src</span><span class="o">+</span> <span class="mi">8</span> <span class="p">)</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
</span><span class="line">        <span class="n">MPIXEL_X4</span><span class="p">(</span> <span class="n">src</span><span class="o">+</span><span class="mi">12</span> <span class="p">)</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
</span><span class="line">        <span class="n">src</span> <span class="o">+=</span> <span class="n">FDEC_STRIDE</span><span class="p">;</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>其中<code>PIXEL_SPLAT_X4</code>定义如下：</p>

<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">#   define PIXEL_SPLAT_X4(x) ((x)*0x01010101U)</span></code></pre></td></tr></table></div></figure>
<p>该宏的作用是将1字节的数据，扩展为4字节的数据，其中的每个字节大小与起始的第一个字节相等。
分析上面的代码结合上面的图，可以看出，每执行一次for循环，都对<code>16x16</code>的每一行像素进行赋值，而赋值的最小单位是4byte，一行像素
需要4次赋值完成，值得大小就是宏块的左边像素值得大小。执行完整个for循环后，16x16宏块像素值结束。</p>

<p>针对<code>AARCH64</code>平台，X264 做了汇编优化，其代码如下：</p>

<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class=""><span class="line">function x264_predict_16x16_h_neon, export=1
</span><span class="line">    sub x1, x0, #1
</span><span class="line">    mov x7, #FDEC_STRIDE
</span><span class="line">.rept 8
</span><span class="line">    ldlr {v0.16b}, [x1], x7
</span><span class="line">    ldlr {v0.16b}, [x1], x7
</span><span class="line">    stl  {v0.16b}, [x0], x7
</span><span class="line">    stl  {v0.16b}, [x0], x7
</span><span class="line">.endr
</span><span class="line">    ret
</span><span class="line">endfunc</span></code></pre></td></tr></table></div></figure>

<h3 id="intra16x16dc-">Intra_16x16_DC 预测模式</h3>

<p>在 SPEC 中，关于该预测模式的定义如下：</p>

<blockquote><p>This Intra_16x16 prediction mode operates, depending on whether the neighbouring samples are marked as "available for Intra_16x16 prediction", as follows:  </p><p>If all neighbouring samples p[x,-1] ], with x = 0..15, and p[ −1, y ], with y = 0..15, are marked as "available for Intra_16x16 prediction", the prediction for all luma samples in the macroblock is given by: $pred_L[x,y]=(\sum_{x'=0}^{15}p[x',-1]+\sum_{y'=0}^{15}p[-1,y']+16)&gt;&gt;5, with x,y=0..15$  </p><p>Otherwise, if any of the neighbouring samples p[ x, .1 ], with x = 0..15, are marked as "not available for Intra_16x16 prediction" and all of the neighbouring samples p[ .1, y ], with y = 0..15, are marked as "available for Intra_16x16 prediction", the prediction for all luma samples in the macroblock is given by: $pred_L[x,y]=(\sum_{y'=0}^{15}p[-1,y']+8)&gt;&gt;4, with x,y=0..15$   </p><p>Otherwise, if any of the neighbouring samples p[ −1, y ], with y = 0..15, are marked as "not available for Intra_16x16 prediction" and all of the neighbouring samples p[ x, −1 ], with x = 0..15, are marked as "available for Intra_16x16 prediction", the prediction for all luma samples in the macroblock is given by: $pred_L[x,y]=(\sum_{x'=0}^{15}p[x',-1]+8)&gt;&gt;4, with x,y=0..15$   </p><p>Otherwise (some of the neighbouring samples p[ x, .1 ], with x = 0..15, and some of the neighbouring samples p[ .1, y ], with y = 0..15, are marked as "not available for Intra_16x16 prediction"), the prediction for all luma samples in the macroblock is given by: $pred_L[x,y]=(1&lt;&lt;(BitDepth_Y - 1)), with x,y=0..15$</p></blockquote>

<p>通过 SPEC 描述可以看出来，DC 模式分为4种情况，一种是宏块的上方和左方宏块像素均可用时，此时宏块内的像素值为参考像素值得平均值；第二种是当左方像素不可用、上方像素可用时，宏块内的像素值为上方可用像素的平均值；
第三种是当上方像素不可用、左方像素可用时，宏块内的像素值为左方可用像素的平均值。最后一种，当上方和左方像素均不可用时，宏块内像素值与BitDepth有关。此处仅仅举例上方和左方像素均可用的例子。</p>

<p>x264 中关于模式 DC 的代码如下：</p>

<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
</pre></td><td class="code"><pre><code class="c"><span class="line"><span class="cp">#define PREDICT_16x16_DC(v)\</span>
</span><span class="line"><span class="cp">    for( int i = 0; i &lt; 16; i++ )\</span>
</span><span class="line"><span class="cp">    {\</span>
</span><span class="line"><span class="cp">        MPIXEL_X4( src+ 0 ) = v;\</span>
</span><span class="line"><span class="cp">        MPIXEL_X4( src+ 4 ) = v;\</span>
</span><span class="line"><span class="cp">        MPIXEL_X4( src+ 8 ) = v;\</span>
</span><span class="line"><span class="cp">        MPIXEL_X4( src+12 ) = v;\</span>
</span><span class="line"><span class="cp">        src += FDEC_STRIDE;\</span>
</span><span class="line"><span class="cp">    }</span>
</span><span class="line">
</span><span class="line"><span class="kt">void</span> <span class="nf">x264_predict_16x16_dc_c</span><span class="p">(</span> <span class="n">pixel</span> <span class="o">*</span><span class="n">src</span> <span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">dc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">    <span class="k">for</span><span class="p">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
</span><span class="line">    <span class="p">{</span>
</span><span class="line">        <span class="n">dc</span> <span class="o">+=</span> <span class="n">src</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">FDEC_STRIDE</span><span class="p">];</span>
</span><span class="line">        <span class="n">dc</span> <span class="o">+=</span> <span class="n">src</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">FDEC_STRIDE</span><span class="p">];</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="n">pixel4</span> <span class="n">dcsplat</span> <span class="o">=</span> <span class="n">PIXEL_SPLAT_X4</span><span class="p">(</span> <span class="p">(</span> <span class="n">dc</span> <span class="o">+</span> <span class="mi">16</span> <span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span> <span class="p">);</span>
</span><span class="line">
</span><span class="line">    <span class="n">PREDICT_16x16_DC</span><span class="p">(</span> <span class="n">dcsplat</span> <span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h3 id="intra16x16plane-">Intra_16x16_Plane 预测模式</h3>

<p>在 SPEC 中，关于该预测模式的定义如下：</p>

<blockquote><p>This Intra_16x16 prediction mode shall be used only when the samples p[ x, .1 ] with x = .1..15 and p[ .1, y ] with y = 0..15 are marked as "available for Intra_16x16 prediction".  <br />The values of the prediction samples $pred_L[x,y]$,with x,y=0...15, are derived by  <br />$pred_L[x,y]=Clip1_Y((a+b*(x-7)+c*(y-7)+16)&gt;&gt;5)$,with x,y=0...15, where   <br />$a = 16 * ( p[ .1, 15 ] + p[ 15, .1 ] )$   <br />$b = ( 5 * H + 32 ) &gt;&gt; 6$   <br />$c = ( 5 * V + 32 ) &gt;&gt; 6$     <br />and H and V are specified as   <br />$H=\sum_{x'=0}^{7}(x'+1)*(p[8+x',-1]-p[6-x',-1])$    <br />$V=\sum_{y'=0}^{7}(y'+1)*(p[-1,8+y']-p[-1,6-y'])$</p></blockquote>

<p>x264 中关于模式 Plane 的代码如下：</p>

<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
</pre></td><td class="code"><pre><code class="c"><span class="line"><span class="kt">void</span> <span class="nf">x264_predict_16x16_p_c</span><span class="p">(</span> <span class="n">pixel</span> <span class="o">*</span><span class="n">src</span> <span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">H</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">    <span class="cm">/* calculate H and V */</span>
</span><span class="line">    <span class="k">for</span><span class="p">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
</span><span class="line">    <span class="p">{</span>
</span><span class="line">        <span class="n">H</span> <span class="o">+=</span> <span class="p">(</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">src</span><span class="p">[</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">i</span> <span class="o">-</span> <span class="n">FDEC_STRIDE</span> <span class="p">]</span> <span class="o">-</span> <span class="n">src</span><span class="p">[</span><span class="mi">6</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">FDEC_STRIDE</span><span class="p">]</span> <span class="p">);</span>
</span><span class="line">        <span class="n">V</span> <span class="o">+=</span> <span class="p">(</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">src</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8</span><span class="o">+</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">FDEC_STRIDE</span><span class="p">]</span> <span class="o">-</span> <span class="n">src</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">6</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">FDEC_STRIDE</span><span class="p">]</span> <span class="p">);</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">
</span><span class="line">    <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">*</span> <span class="p">(</span> <span class="n">src</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">15</span><span class="o">*</span><span class="n">FDEC_STRIDE</span><span class="p">]</span> <span class="o">+</span> <span class="n">src</span><span class="p">[</span><span class="mi">15</span> <span class="o">-</span> <span class="n">FDEC_STRIDE</span><span class="p">]</span> <span class="p">);</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="p">(</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">H</span> <span class="o">+</span> <span class="mi">32</span> <span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="p">(</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">V</span> <span class="o">+</span> <span class="mi">32</span> <span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">    <span class="kt">int</span> <span class="n">i00</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span> <span class="o">*</span> <span class="mi">7</span> <span class="o">-</span> <span class="n">c</span> <span class="o">*</span> <span class="mi">7</span> <span class="o">+</span> <span class="mi">16</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">    <span class="k">for</span><span class="p">(</span> <span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span> <span class="p">)</span>
</span><span class="line">    <span class="p">{</span>
</span><span class="line">        <span class="kt">int</span> <span class="n">pix</span> <span class="o">=</span> <span class="n">i00</span><span class="p">;</span>
</span><span class="line">        <span class="k">for</span><span class="p">(</span> <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span> <span class="p">)</span>
</span><span class="line">        <span class="p">{</span>
</span><span class="line">            <span class="n">src</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">x264_clip_pixel</span><span class="p">(</span> <span class="n">pix</span><span class="o">&gt;&gt;</span><span class="mi">5</span> <span class="p">);</span>
</span><span class="line">            <span class="n">pix</span> <span class="o">+=</span> <span class="n">b</span><span class="p">;</span>
</span><span class="line">        <span class="p">}</span>
</span><span class="line">        <span class="n">src</span> <span class="o">+=</span> <span class="n">FDEC_STRIDE</span><span class="p">;</span>
</span><span class="line">        <span class="n">i00</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="k">static</span> <span class="n">ALWAYS_INLINE</span> <span class="n">pixel</span> <span class="nf">x264_clip_pixel</span><span class="p">(</span> <span class="kt">int</span> <span class="n">x</span> <span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="k">return</span> <span class="p">(</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PIXEL_MAX</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">31</span> <span class="o">&amp;</span> <span class="nl">PIXEL_MAX</span> <span class="p">:</span> <span class="n">x</span> <span class="p">);</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">李冰</span></span>

      




<time class='entry-date' datetime='2017-06-30T08:12:22-07:00'><span class='date'>2017 年 06 月 30 日</span> <span class='time'>8:12 am</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/x264/'>x264</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://lazybing.github.io/blog/2017/06/30/x264-intra-prediction/" data-via="" data-counturl="http://lazybing.github.io/blog/2017/06/30/x264-intra-prediction/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2017/06/24/x264-encoder-open/" title="Previous Post: x264源码解析之x264_encoder_open函数">&laquo; x264源码解析之x264_encoder_open函数</a>
      
      
        <a class="basic-alignment right" href="/blog/2017/07/08/x264-inter-prediction/" title="Next Post: x264 源码解析之帧间预测">x264 源码解析之帧间预测 &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
      <h1>分类目录</h1>
        <ul id="categories">
                <li class='category'><a href='/blog/categories/av1/'>av1 (8)</a></li>
<li class='category'><a href='/blog/categories/ffmpegyuan-ma-fen-xi/'>ffmpeg源码分析 (13)</a></li>
<li class='category'><a href='/blog/categories/hevcxue-xi/'>hevc学习 (7)</a></li>
<li class='category'><a href='/blog/categories/hmyuan-ma-fen-xi/'>hm源码分析 (5)</a></li>
<li class='category'><a href='/blog/categories/rtmpyuan-ma-fen-xi/'>rtmp源码分析 (2)</a></li>
<li class='category'><a href='/blog/categories/x264/'>x264 (20)</a></li>
<li class='category'><a href='/blog/categories/xing-neng-you-hua/'>性能优化 (7)</a></li>
<li class='category'><a href='/blog/categories/zong-jie-ji-lei/'>总结积累 (9)</a></li>
<li class='category'><a href='/blog/categories/hui-bian-xue-xi/'>汇编学习 (8)</a></li>
<li class='category'><a href='/blog/categories/bian-cheng-gong-ju/'>编程工具 (7)</a></li>
<li class='category'><a href='/blog/categories/shi-pin-ji-chu/'>视频基础 (3)</a></li>
<li class='category'><a href='/blog/categories/du-shu-bi-ji/'>读书笔记 (3)</a></li>
<li class='category'><a href='/blog/categories/xiang-mu-shi-jian/'>项目实践 (4)</a></li>

                  </ul>
</section>
<section>
  <h1>最新文章</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2019/11/14/intra-color-palette-predictor/">AV1(DAV1D)解码详解(七)之帧内编码 Color Palette</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/11/13/inter-overlapped-block-motion-compensation/">AV1(DAV1D)解码详解(七)之帧间编码 OBMC</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/11/12/intra-chrom-from-luma/">AV1(DAV1D) 解码详解(六)之帧内编码 Chroma_From_Luma</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/07/11/doxygen-graphviz/">Doxygen和graphviz使用</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/07/10/deblock-filter/">AV1(DAV1D) 解码详解(五)之DEBLOCK FILTER</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>微博</h1>
  <ul id="weibo">
    <li>
        <iframe 
            width="100%" 
            height="350" 
            class="share_self"  
            frameborder="0" 
            scrolling="no" 
            src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=350&fansRow=0&ptype=1&speed=0&skin=1&isTitle=1&noborder=1&isWeibo=1&isFans=1&uid=1882167025&verifier=64bf2e00&dpc=1">
        </iframe>
    </li>
  </ul">
</section>

<section>
    <h1>微信</h1>
    <img src="/images/weixin.png">
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.3/jquery.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){

      // hide #back-top first
      $("#back-top").hide();
        
        // fade in #back-top
        $(function () {
           $(window).scroll(function () {
                 if ($(this).scrollTop() > 100) {
                     $('#back-top').fadeIn();
                 } else {
                     $('#back-top').fadeOut();
                 }
           });

          // scroll body to 0px on click
          $('#back-top a').click(function () {
              $('body,html').animate({
                  scrollTop: 0
              }, 800);
              return false;
         });
     });

});
</script>

<style type="text/css">
#back-top {
      position: fixed;
      bottom: 50px;
      right: 100px;
}

#back-top a {
      width: 80px;
      display: block;
      text-align: center;
      font: 11px/100% Arial, Helvetica, sans-serif;
      text-transform: uppercase;
      text-decoration: none;
      color: #bbb;

      /* transition */
      -webkit-transition: 1s;
      -moz-transition: 1s;
      transition: 1s;
}
#back-top a:hover {
      color: #000;
}

/* arrow icon (span tag) */
#back-top span {
      width: 80px;
      height: 80px;
      display: block;
      margin-bottom: 7px;
      background: #ddd url(/images/top.png) no-repeat center center;

      /* rounded corners */
      -webkit-border-radius: 15px;
      -moz-border-radius: 15px;
      border-radius: 15px;

      /* transition */
      -webkit-transition: 1s;
      -moz-transition: 1s;
      transition: 1s;
}
#back-top a:hover span {
      background-color: #888;
}
</style>

<p id="back-top">
  <a href="#top"><span></span></a>
</p>

<p>
  Copyright &copy; 2019 - 李冰 -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1259410454'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s11.cnzz.com/z_stat.php%3Fid%3D1259410454%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"));</script>
</p>

<!-- MathJax -->  
<script type="text/x-mathjax-config">  
    MathJax.Hub.Config({  
                       tex2jax: {  
                       inlineMath: [ ['$','$'], ["\\(","\\)"] ],  
                       processEscapes: true  
                       }  
                       });  
    </script>  
  
<script type="text/x-mathjax-config">  
    MathJax.Hub.Config({  
                       tex2jax: {  
                       skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']  
                       }  
                       });  
    </script>  
  
<script type="text/x-mathjax-config">  
    MathJax.Hub.Queue(function() {  
                      var all = MathJax.Hub.getAllJax(), i;  
                      for(i=0; i < all.length; i += 1) {  
                      all[i].SourceElement().parentNode.className += ' has-jax';  
                      }  
                      });  
    </script>  
  
<script type="text/javascript"  
    src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">  
    </script>  

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
